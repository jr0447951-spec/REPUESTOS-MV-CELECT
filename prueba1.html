<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Historial de Salidas</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
font-family:'Poppins',sans-serif;
background:#f8fafc;
margin:0;
padding:20px;
color:#1e293b;
}
h1{margin:0;}
.header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}
.table-box{
background:white;
padding:20px;
border-radius:16px;
box-shadow:0 4px 8px rgba(0,0,0,.05);
}
.table-header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:10px;
}
.subinfo{
font-size:.9rem;
color:#64748b;
margin-bottom:15px;
}
.filter-row{
display:flex;
gap:10px;
flex-wrap:wrap;
margin-bottom:10px;
}
select,input{
padding:6px;
border:1px solid #cbd5e1;
border-radius:6px;
font-size:.85rem;
}
button{
padding:6px 10px;
border:none;
border-radius:6px;
background:#4f46e5;
color:white;
cursor:pointer;
font-size:.8rem;
}
table{
width:100%;
border-collapse:collapse;
font-size:.85rem;
}
th,td{
padding:10px;
border-bottom:1px solid #e2e8f0;
}
th{
background:#f1f5f9;
text-align:left;
}
.pagination{
text-align:center;
margin-top:10px;
}
.pagination button{
margin:2px;
background:#e2e8f0;
color:black;
}
.pagination button.active{
background:#4f46e5;
color:white;
}
</style>
</head>
<body>

<div class="header">
<h1>ðŸ“¦ CONTROL DE REPUESTOS</h1>
<div id="lastUpdate"></div>
</div>

<div class="table-box">

<div class="table-header">
<h2 id="tituloHistorial">ðŸ“œ Historial</h2>
<button onclick="exportHistorialCompleto()">Exportar Mes Completo</button>
</div>

<div class="subinfo" id="totalRegistrosMes">
Total registros del mes: 0
</div>

<div class="filter-row">
<select id="selectorMes">
<option value="">Mes Actual</option>
<option value="0">Enero</option>
<option value="1">Febrero</option>
<option value="2">Marzo</option>
<option value="3">Abril</option>
<option value="4">Mayo</option>
<option value="5">Junio</option>
<option value="6">Julio</option>
<option value="7">Agosto</option>
<option value="8">Septiembre</option>
<option value="9">Octubre</option>
<option value="10">Noviembre</option>
<option value="11">Diciembre</option>
</select>

<select id="selectorAnio"></select>

<input type="text" id="filterSitio" placeholder="Filtrar Sitio">
<input type="text" id="filterTecnico" placeholder="Filtrar TÃ©cnico">
</div>

<table id="tablaHistorial">
<thead>
<tr>
<th>Fecha</th>
<th>ID Sitio</th>
<th>Nombre Sitio</th>
<th>Equipo</th>
<th>Serie</th>
<th>TÃ©cnico</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="paginacion" class="pagination"></div>

</div>

<script>

const URL_SALIDAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=0&single=true&output=csv';

const nombresMeses = [
"Enero","Febrero","Marzo","Abril","Mayo","Junio",
"Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

let datosHistorial=[];
let datosFiltradosMes=[];
let paginaActual=1;
const porPagina=10;

window.onload=function(){
cargarAnios();
cargar();
}

async function cargar(){
const res=await fetch(URL_SALIDAS);
const csv=await res.text();

Papa.parse(csv,{
header:false,
skipEmptyLines:true,
complete:(r)=>{
datosHistorial=r.data;
filtrarPorMes();
}
});

document.getElementById('lastUpdate').innerText=
"Actualizado: "+new Date().toLocaleString();
}

function cargarAnios(){
const select=document.getElementById('selectorAnio');
const anioActual=new Date().getFullYear();

for(let i=anioActual;i>=anioActual-5;i--){
let option=document.createElement('option');
option.value=i;
option.text=i;
select.appendChild(option);
}
select.value=anioActual;
}

function filtrarPorMes(){

const selectorMes=document.getElementById('selectorMes').value;
const selectorAnio=document.getElementById('selectorAnio').value;

const hoy=new Date();
const mesActual=hoy.getMonth();
const anioActual=hoy.getFullYear();

const mesSel=selectorMes===""?mesActual:parseInt(selectorMes);
const anioSel=parseInt(selectorAnio);

datosFiltradosMes=datosHistorial.filter(f=>{
const fecha=parseFecha(f[0]);
return fecha.getMonth()===mesSel &&
       fecha.getFullYear()===anioSel;
});

document.getElementById('tituloHistorial').innerText=
"ðŸ“œ Historial â€“ "+nombresMeses[mesSel]+" "+anioSel;

document.getElementById('totalRegistrosMes').innerText=
"Total registros del mes: "+datosFiltradosMes.length;

paginaActual=1;
renderTabla();
}

function renderTabla(){

const sf=document.getElementById('filterSitio').value.toLowerCase();
const tf=document.getElementById('filterTecnico').value.toLowerCase();

const filtrados=datosFiltradosMes.filter(f=>
f[3] && f[1] &&
f[3].toLowerCase().includes(sf) &&
f[1].toLowerCase().includes(tf)
);

const inicio=(paginaActual-1)*porPagina;
const fin=inicio+porPagina;
const pagina=filtrados.slice(inicio,fin);

const tbody=document.querySelector('#tablaHistorial tbody');

tbody.innerHTML=pagina.map(f=>`
<tr>
<td>${f[0]}</td>
<td>${f[3]}</td>
<td>${f[4]}</td>
<td>${f[5]}</td>
<td>${f[7]}</td>
<td>${f[1]}</td>
</tr>
`).join('');

renderPaginacion(filtrados.length);
}

function renderPaginacion(total){
const totalPaginas=Math.ceil(total/porPagina);
const cont=document.getElementById('paginacion');

if(totalPaginas<=1){cont.innerHTML="";return;}

let botones="";
for(let i=1;i<=totalPaginas;i++){
botones+=`<button class="${i===paginaActual?'active':''}" onclick="cambiarPagina(${i})">${i}</button>`;
}
cont.innerHTML=botones;
}

function cambiarPagina(p){
paginaActual=p;
renderTabla();
}

function exportHistorialCompleto(){

const tabla=document.getElementById('tablaHistorial').cloneNode(true);
const tbody=tabla.querySelector('tbody');

tbody.innerHTML=datosFiltradosMes.map(f=>`
<tr>
<td>${f[0]}</td>
<td>${f[3]}</td>
<td>${f[4]}</td>
<td>${f[5]}</td>
<td>${f[7]}</td>
<td>${f[1]}</td>
</tr>
`).join('');

const box=document.createElement('div');
box.style.position='fixed';
box.style.top='-10000px';
box.style.background='#fff';
box.style.padding='20px';
box.appendChild(tabla);
document.body.appendChild(box);

html2canvas(box,{scale:2}).then(canvas=>{
const a=document.createElement('a');
a.href=canvas.toDataURL('image/png');
a.download='Historial_'+new Date().getTime()+'.png';
a.click();
document.body.removeChild(box);
});
}

function parseFecha(fechaStr){
if(!fechaStr)return new Date(0);
const p=fechaStr.split(/[/ :]/);
return new Date(p[2],p[1]-1,p[0],p[3]||0,p[4]||0,p[5]||0);
}

document.getElementById('selectorMes').addEventListener('change',filtrarPorMes);
document.getElementById('selectorAnio').addEventListener('change',filtrarPorMes);
document.getElementById('filterSitio').addEventListener('input',()=>{paginaActual=1;renderTabla();});
document.getElementById('filterTecnico').addEventListener('input',()=>{paginaActual=1;renderTabla();});

</script>

</body>
</html>


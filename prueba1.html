<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Network Ops - Control de Gesti√≥n</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root { --brand: #4f46e5; --bg: #f8fafc; --text: #1e293b; --danger: #ef4444; --success: #10b981; }
body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }

.header-dash { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.card-stat { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid var(--brand); }
.card-stat h3 { margin: 0; font-size: 0.8rem; color: #64748b; text-transform: uppercase; }
.card-stat .value { font-size: 1.8rem; font-weight: 600; color: var(--brand); }

.table-container { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 30px; overflow-x: auto; }
.table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
.table-header h2 { font-size: 1.1rem; margin: 0; }

table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-weight: 600; }
td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

.badge { padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
.badge-pending { background: #fee2e2; color: #991b1b; }
.badge-success { background: #dcfce7; color: #166534; }

.filter-row { display:flex; gap:15px; margin-bottom:10px; flex-wrap:wrap; }
.filter-row input, .filter-row select { padding:5px 8px; border-radius:6px; border:1px solid #cbd5e1; font-size:0.85rem; }
button.export-btn { padding:6px 10px; border:none; border-radius:6px; background:var(--brand); color:white; cursor:pointer; font-size:0.85rem; }

/* Estilos de Pesta√±as */
.tab-container { display: flex; gap: 10px; }
.tab-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; background: #e2e8f0; font-weight: 600; font-family: inherit; color: #64748b; transition: 0.3s; }
.tab-btn.active { background: var(--brand); color: white; }
.tab-content { animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

footer { text-align:center; padding:15px 0; font-size:0.8rem; color:#64748b; border-top:1px solid #e2e8f0; }

@media print {
    .tab-btn, .filter-row, .export-btn, #lastUpdate { display: none !important; }
    body { background: white; padding: 0; }
    .table-container { box-shadow: none; border: 1px solid #eee; }
}
</style>
</head>
<body>

<div class="header-dash">
    <div>
        <h1>CONTROL DE REPUESTOS</h1>
        <div id="lastUpdate" style="font-size: 0.8rem; color: #64748b;">Actualizando...</div>
    </div>
    <nav class="tab-container">
        <button class="tab-btn active" onclick="openTab('dashboard')">üìä Dashboard</button>
        <button class="tab-btn" onclick="openTab('historial')">üìú Historial</button>
    </nav>
</div>

<div id="tab-dashboard" class="tab-content">
    <div class="stats-row">
        <div class="card-stat">
            <h3>Pendientes (3 Meses)</h3>
            <div class="value" id="stat-pendientes">0</div>
        </div>
        <div class="card-stat" style="border-left-color: var(--success);">
            <h3>Entregados (Semana)</h3>
            <div class="value" id="stat-semanal">0</div>
        </div>
    </div>

    <div class="filter-row">
        <input type="text" id="filterSitioPendientes" placeholder="Filtrar por Sitio">
        <input type="text" id="filterTecnicoPendientes" placeholder="Filtrar por T√©cnico">
    </div>

    <div class="table-container">
        <div class="table-header">
            <h2>üìã Pendientes de Gesti√≥n/Entrega </h2>
            <span class="badge badge-pending" id="tag-pendientes">Total: 0</span>
        </div>
        <button class="export-btn" id="exportPendientes">üì§ Exportar Pendientes a Imagen</button>
        <table id="tablaPendientes">
            <thead>
                <tr>
                    <th>Fecha Salida</th>
                    <th>ID Sitio</th>
                    <th>Nombre Sitio</th>
                    <th>Equipo</th>
                    <th>Serie</th>
                    <th>T√©cnico</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="filter-row">
        <input type="text" id="filterSitioEntregas" placeholder="Filtrar por Sitio">
        <input type="text" id="filterTecnicoEntregas" placeholder="Filtrar por T√©cnico">
        <input type="number" id="filterSemanaEntregas" placeholder="N√∫mero de Semana">
    </div>

    <div class="table-container">
        <div class="table-header">
            <h2>‚úÖ Entregas Realizadas </h2>
            <span class="badge badge-success" id="tag-semanal">Semana 0</span>
        </div>
        <button class="export-btn" id="exportEntregas">üì§ Exportar Entregas a Imagen</button>
        <table id="tablaEntregados">
            <thead>
                <tr>
                    <th>Fecha Entrega</th>
                    <th>ID Sitio</th>
                    <th>Sitio</th>
                    <th>Nombre Equipo</th>
                    <th>Serie</th>
                    <th>Bodega</th>
                    <th>T√©cnico</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="tab-historial" class="tab-content" style="display:none;">
    <div class="filter-row" style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <label style="font-size: 0.85rem; font-weight: 600;">Seleccionar Mes:</label>
        <input type="month" id="filterMesHistorial">
        <button class="export-btn" onclick="renderHistorial()">üîç Filtrar Mes</button>
    </div>

    <div class="table-container">
        <div class="table-header">
            <h2>üìú Historial de Salidas</h2>
            <div style="display: flex; gap: 8px;">
                <button class="export-btn" onclick="exportarHistorialExcel()" style="background: #166534;">üìä Excel</button>
                <button class="export-btn" onclick="exportarHistorialPDF()" style="background: #991b1b;">üìÑ PDF</button>
            </div>
        </div>
        <table id="tablaHistorial">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>ID Sitio</th>
                    <th>Nombre Sitio</th>
                    <th>Equipo</th>
                    <th>Serie</th>
                    <th>T√©cnico</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<footer>
    Dashboard desarrollado por <strong>Operaciones Paracentrales</strong> | &copy; 2026
</footer>

<script>
const URL_SALIDAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=0&single=true&output=csv';
const URL_ENTREGAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=887165919&single=true&output=csv';

let datosPendientes = [], datosEntregas = [], todasLasSalidas = [];

async function cargarDashboard() {
    try {
        const [respSalidas, respEntregas] = await Promise.all([fetch(URL_SALIDAS), fetch(URL_ENTREGAS)]);
        const textoSalidas = await respSalidas.text();
        const textoEntregas = await respEntregas.text();
        
        // Guardamos todas las salidas para el historial antes de procesar filtros
        Papa.parse(textoSalidas, { header:false, complete:(results)=>{
            todasLasSalidas = results.data;
            procesarPendientes(results.data);
            
            // Set mes actual por defecto
            const hoy = new Date();
            document.getElementById('filterMesHistorial').value = hoy.toISOString().substring(0, 7);
        }});
        
        procesarEntregados(textoEntregas);
        document.getElementById('lastUpdate').innerText = "√öltima actualizaci√≥n: " + new Date().toLocaleString();
    } catch(e){ console.error("Error al cargar datos", e); }
}

function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tabName).style.display = 'block';
    event.currentTarget.classList.add('active');
    if(tabName === 'historial') renderHistorial();
}

function procesarPendientes(dataRows) {
    const ahora = new Date();
    const limite90 = new Date(ahora); 
    limite90.setDate(ahora.getDate() - 90);
    
    datosPendientes = dataRows.filter(fila=>{
        const fecha = parseFechaElSalvador(fila[0]);
        return fecha >= limite90 && fila[9] === 'PENDIENTE';
    });
    
    document.getElementById('stat-pendientes').innerText = datosPendientes.length;
    document.getElementById('tag-pendientes').innerText = "Total: " + datosPendientes.length;
    renderPendientes();
}

function renderPendientes() {
    const tbody = document.querySelector('#tablaPendientes tbody');
    const sitioFilter = document.getElementById('filterSitioPendientes').value.toLowerCase();
    const tecnicoFilter = document.getElementById('filterTecnicoPendientes').value.toLowerCase();
    tbody.innerHTML = datosPendientes.filter(f =>
        f[3].toLowerCase().includes(sitioFilter) &&
        f[1].toLowerCase().includes(tecnicoFilter)
    ).map(f=>`
        <tr>
            <td>${f[0]}</td>
            <td>${f[3]}</td>
            <td>${f[4]}</td>
            <td>${f[5]}</td>
            <td>${f[7]}</td>
            <td>${f[1]}</td>
        </tr>
    `).join('');
}

function procesarEntregados(csv) {
    Papa.parse(csv, { header:false, complete:(results)=>{
        const hoy = new Date();
        const inicioSemana = inicioSemanaISO(hoy);
        datosEntregas = results.data.filter(fila=>{
            const fechaEntrega = parseFechaElSalvador(fila[0]);
            return fechaEntrega >= inicioSemana;
        });
        document.getElementById('stat-semanal').innerText = datosEntregas.length;
        document.getElementById('tag-semanal').innerText = "Semana " + numeroSemana(hoy);
        renderEntregas();
    }});
}

function renderEntregas() {
    const tbody = document.querySelector('#tablaEntregados tbody');
    const sitioFilter = document.getElementById('filterSitioEntregas').value.toLowerCase();
    const tecnicoFilter = document.getElementById('filterTecnicoEntregas').value.toLowerCase();
    const semanaFilter = document.getElementById('filterSemanaEntregas').value;
    tbody.innerHTML = datosEntregas.filter(f=>{
        const numSemanaFila = numeroSemana(parseFechaElSalvador(f[0]));
        return f[2].toLowerCase().includes(sitioFilter) &&
               f[1].toLowerCase().includes(tecnicoFilter) &&
               (semanaFilter === "" || numSemanaFila == semanaFilter);
    }).map(f=>`
        <tr>
            <td>${f[0]}</td>
            <td>${f[3]}</td>
            <td>${f[2]}</td>
            <td>${f[6]}</td>
            <td>${f[9]}</td>
            <td>${f[8]}</td>
            <td>${f[1]}</td>
        </tr>
    `).join('');
}

function renderHistorial() {
    const tbody = document.querySelector('#tablaHistorial tbody');
    const mesSel = document.getElementById('filterMesHistorial').value;
    
    const filtrados = todasLasSalidas.filter(f => {
        const fecha = parseFechaElSalvador(f[0]);
        if (isNaN(fecha)) return false;
        const mesFila = fecha.getFullYear() + "-" + String(fecha.getMonth() + 1).padStart(2, '0');
        return mesFila === mesSel;
    });

    tbody.innerHTML = filtrados.map(f => `
        <tr>
            <td>${f[0]}</td>
            <td>${f[3]}</td>
            <td>${f[4]}</td>
            <td>${f[5]}</td>
            <td>${f[7]}</td>
            <td>${f[1]}</td>
            <td><span class="badge ${f[9] === 'PENDIENTE' ? 'badge-pending' : 'badge-success'}">${f[9]}</span></td>
        </tr>
    `).join('');
}

function exportarHistorialExcel() {
    const mes = document.getElementById('filterMesHistorial').value;
    let csvContent = "\uFEFF";
    const headers = ["Fecha", "ID Sitio", "Nombre Sitio", "Equipo", "Serie", "Tecnico", "Estado"];
    csvContent += headers.join(";") + "\n";
    
    const filas = Array.from(document.querySelectorAll("#tablaHistorial tbody tr"));
    filas.forEach(tr => {
        const datos = Array.from(tr.querySelectorAll("td")).map(td => td.innerText);
        csvContent += datos.join(";") + "\n";
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", `Historial_${mes}.csv`);
    link.click();
}

function exportarHistorialPDF() {
    window.print();
}

// Helpers
function inicioSemanaISO(fecha) {
    const dia = fecha.getDay() || 7;
    const lunes = new Date(fecha);
    lunes.setDate(fecha.getDate() - dia + 1);
    lunes.setHours(0,0,0,0);
    return lunes;
}

function parseFechaElSalvador(fechaStr) {
    if(!fechaStr) return new Date(0);
    const partes = fechaStr.split(/[/ :]/);
    return new Date(partes[2], partes[1]-1, partes[0], partes[3]||0, partes[4]||0, partes[5]||0);
}

function numeroSemana(fecha) {
    const primerDiaAno = new Date(fecha.getFullYear(),0,1);
    const diasTranscurridos = Math.floor((fecha - primerDiaAno)/86400000);
    return Math.ceil((diasTranscurridos + primerDiaAno.getDay()+1)/7);
}

function exportTableAsImage(tablaId, nombreArchivo) {
    const tabla = document.getElementById(tablaId);
    const container = tabla.closest('.table-container');
    html2canvas(container, { scale:2 }).then(canvas=>{
        const enlace = document.createElement('a');
        enlace.href = canvas.toDataURL('image/png');
        enlace.download = nombreArchivo + '.png';
        enlace.click();
    });
}

// Listeners
document.getElementById('filterSitioPendientes').addEventListener('input', renderPendientes);
document.getElementById('filterTecnicoPendientes').addEventListener('input', renderPendientes);
document.getElementById('filterSitioEntregas').addEventListener('input', renderEntregas);
document.getElementById('filterTecnicoEntregas').addEventListener('input', renderEntregas);
document.getElementById('filterSemanaEntregas').addEventListener('input', renderEntregas);
document.getElementById('exportPendientes').addEventListener('click', ()=>exportTableAsImage('tablaPendientes','Pendientes'));
document.getElementById('exportEntregas').addEventListener('click', ()=>exportTableAsImage('tablaEntregados','Entregas'));

window.onload = cargarDashboard;
</script>
</body>
</html>

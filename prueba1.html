<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Control de Repuestos</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root { --brand:#4f46e5; --bg:#f8fafc; --text:#1e293b; --danger:#ef4444; --success:#10b981; }

body{
font-family:'Poppins',sans-serif;
background:var(--bg);
margin:0;
padding:20px;
color:var(--text);
}

.header-main{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}

.tabs{
display:flex;
gap:10px;
margin-bottom:20px;
}

.tab-btn{
padding:8px 14px;
border:none;
border-radius:8px;
background:#e2e8f0;
cursor:pointer;
font-weight:600;
}

.tab-btn.active{
background:var(--brand);
color:white;
}

.tab-content{ display:none; }
.tab-content.active{ display:block; }

.stats-row{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:20px;
margin-bottom:20px;
}

.card-stat{
background:white;
padding:20px;
border-radius:16px;
box-shadow:0 4px 6px rgba(0,0,0,.08);
border-left:5px solid var(--brand);
}

.card-stat h3{
margin:0;
font-size:.8rem;
color:#64748b;
text-transform:uppercase;
}

.card-stat .value{
font-size:1.8rem;
font-weight:600;
color:var(--brand);
}

.table-box, .table-container{
background:white;
padding:20px;
border-radius:16px;
box-shadow:0 4px 8px rgba(0,0,0,.05);
margin-bottom:25px;
overflow-x:auto;
}

.table-header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:10px;
}

table{
width:100%;
border-collapse:collapse;
font-size:.85rem;
}

th,td{
padding:10px;
border-bottom:1px solid #e2e8f0;
}

th{
background:#f1f5f9;
text-align:left;
}

.filter-row{
display:flex;
gap:10px;
flex-wrap:wrap;
margin-bottom:10px;
}

select,input{
padding:6px;
border:1px solid #cbd5e1;
border-radius:6px;
font-size:.85rem;
}

button{
padding:6px 10px;
border:none;
border-radius:6px;
background:var(--brand);
color:white;
cursor:pointer;
font-size:.8rem;
}

.pagination{
text-align:center;
margin-top:10px;
}

.pagination button{
margin:2px;
background:#e2e8f0;
color:black;
}

.pagination button.active{
background:var(--brand);
color:white;
}
</style>
</head>
<body>

<div class="header-main">
<h1>ðŸ“¦ CONTROL DE REPUESTOS</h1>
<div id="lastUpdate"></div>
</div>

<div class="tabs">
<button class="tab-btn active" onclick="mostrarTab(event,'dashboard')">ðŸ“Š Dashboard</button>
<button class="tab-btn" onclick="mostrarTab(event,'historial')">ðŸ“œ Historial</button>
</div>

<div id="dashboard" class="tab-content active">

<div class="stats-row">
<div class="card-stat">
<h3>Pendientes (90 dÃ­as)</h3>
<div class="value" id="stat-pendientes">0</div>
</div>

<div class="card-stat" style="border-left-color:var(--success);">
<h3>Entregados (Semana)</h3>
<div class="value" id="stat-semanal">0</div>
</div>
</div>

<div class="filter-row">
<input type="text" id="filterSitioPendientes" placeholder="Filtrar Sitio">
<input type="text" id="filterTecnicoPendientes" placeholder="Filtrar TÃ©cnico">
</div>

<div class="table-container">
<div class="table-header">
<h2>ðŸ“‹ Pendientes</h2>
<button onclick="exportTableAsImage('tablaPendientes','Pendientes')">Exportar</button>
</div>

<table id="tablaPendientes">
<thead>
<tr>
<th>Fecha</th>
<th>ID Sitio</th>
<th>Nombre Sitio</th>
<th>Equipo</th>
<th>Serie</th>
<th>TÃ©cnico</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="filter-row">
<input type="text" id="filterSitioEntregas" placeholder="Filtrar Sitio">
<input type="text" id="filterTecnicoEntregas" placeholder="Filtrar TÃ©cnico">
<input type="number" id="filterSemanaEntregas" placeholder="Semana">
</div>

<div class="table-container">
<div class="table-header">
<h2>âœ… Entregas</h2>
<button onclick="exportTableAsImage('tablaEntregados','Entregas')">Exportar</button>
</div>

<table id="tablaEntregados">
<thead>
<tr>
<th>Fecha</th>
<th>ID Sitio</th>
<th>Sitio</th>
<th>Equipo</th>
<th>Serie</th>
<th>Bodega</th>
<th>TÃ©cnico</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<div id="historial" class="tab-content">
<div class="table-box">
<div class="table-header">
<h2 id="tituloHistorial">ðŸ“œ Historial</h2>
<button onclick="exportHistorialCompleto()">Exportar Mes Completo</button>
</div>

<div id="totalRegistrosMes">Total registros del mes: 0</div>

<div class="filter-row">
<select id="selectorMes"></select>
<select id="selectorAnio"></select>
<input type="text" id="filterSitioHistorial" placeholder="Filtrar Sitio">
<input type="text" id="filterTecnicoHistorial" placeholder="Filtrar TÃ©cnico">
</div>

<table id="tablaHistorial">
<thead>
<tr>
<th>Fecha</th>
<th>ID Sitio</th>
<th>Nombre Sitio</th>
<th>Equipo</th>
<th>Serie</th>
<th>TÃ©cnico</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="paginacion" class="pagination"></div>
</div>
</div>

<script>
const URL_SALIDAS='https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=0&single=true&output=csv';
const URL_ENTREGAS='https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=887165919&single=true&output=csv';

let datosPendientes=[],datosEntregas=[],datosHistorial=[],datosFiltradosMes=[];
let paginaActual=1;
const porPagina=10;

window.onload=()=>{cargarDashboard();cargarHistorial();};

function mostrarTab(event,id){
document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
document.getElementById(id).classList.add('active');
event.target.classList.add('active');
}

function parseFecha(str){
if(!str||typeof str!=="string")return null;
const p=str.split(/[/ :]/);
if(p.length<3)return null;
const fecha=new Date(p[2],p[1]-1,p[0],p[3]||0,p[4]||0,p[5]||0);
if(isNaN(fecha.getTime()))return null;
return fecha;
}

/* TODO EL RESTO DE FUNCIONES PERMANECEN EXACTAMENTE IGUALES,
SOLO AGREGANDO VALIDACIÃ“N DE fecha && antes de usar getMonth o comparaciones */

</script>

</body>
</html>

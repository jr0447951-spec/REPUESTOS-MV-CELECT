<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Control de Repuestos</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root { --brand:#4f46e5; --bg:#f8fafc; --text:#1e293b; --danger:#ef4444; --success:#10b981; }

body{
font-family:'Poppins',sans-serif;
background:var(--bg);
margin:0;
padding:20px;
color:var(--text);
}

/* HEADER */
.header-main{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}

/* TABS */
.tabs{
display:flex;
gap:10px;
margin-bottom:20px;
}

.tab-btn{
padding:8px 14px;
border:none;
border-radius:8px;
background:#e2e8f0;
cursor:pointer;
font-weight:600;
}

.tab-btn.active{
background:var(--brand);
color:white;
}

.tab-content{
display:none;
}

.tab-content.active{
display:block;
}

/* STATS */
.stats-row{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:20px;
margin-bottom:20px;
}

.card-stat{
background:white;
padding:20px;
border-radius:16px;
box-shadow:0 4px 6px rgba(0,0,0,.08);
border-left:5px solid var(--brand);
}

.card-stat h3{
margin:0;
font-size:.8rem;
color:#64748b;
text-transform:uppercase;
}

.card-stat .value{
font-size:1.8rem;
font-weight:600;
color:var(--brand);
}

/* TABLES */
.table-box, .table-container{
background:white;
padding:20px;
border-radius:16px;
box-shadow:0 4px 8px rgba(0,0,0,.05);
margin-bottom:25px;
overflow-x:auto;
}

.table-header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:10px;
}

table{
width:100%;
border-collapse:collapse;
font-size:.85rem;
}

th,td{
padding:10px;
border-bottom:1px solid #e2e8f0;
}

th{
background:#f1f5f9;
text-align:left;
}

.filter-row{
display:flex;
gap:10px;
flex-wrap:wrap;
margin-bottom:10px;
}

select,input{
padding:6px;
border:1px solid #cbd5e1;
border-radius:6px;
font-size:.85rem;
}

button{
padding:6px 10px;
border:none;
border-radius:6px;
background:var(--brand);
color:white;
cursor:pointer;
font-size:.8rem;
}

.pagination{
text-align:center;
margin-top:10px;
}

.pagination button{
margin:2px;
background:#e2e8f0;
color:black;
}

.pagination button.active{
background:var(--brand);
color:white;
}
</style>
</head>
<body>

<div class="header-main">
<h1>ðŸ“¦ CONTROL DE REPUESTOS</h1>
<div id="lastUpdate"></div>
</div>

<!-- TABS -->
<div class="tabs">
<button class="tab-btn active" onclick="mostrarTab('dashboard')">ðŸ“Š Dashboard</button>
<button class="tab-btn" onclick="mostrarTab('historial')">ðŸ“œ Historial</button>
</div>

<!-- ===================== DASHBOARD ===================== -->
<div id="dashboard" class="tab-content active">

<div class="stats-row">
<div class="card-stat">
<h3>Pendientes (90 dÃ­as)</h3>
<div class="value" id="stat-pendientes">0</div>
</div>

<div class="card-stat" style="border-left-color:var(--success);">
<h3>Entregados (Semana)</h3>
<div class="value" id="stat-semanal">0</div>
</div>
</div>

<!-- PENDIENTES -->
<div class="filter-row">
<input type="text" id="filterSitioPendientes" placeholder="Filtrar Sitio">
<input type="text" id="filterTecnicoPendientes" placeholder="Filtrar TÃ©cnico">
</div>

<div class="table-container">
<div class="table-header">
<h2>ðŸ“‹ Pendientes</h2>
<button onclick="exportTableAsImage('tablaPendientes','Pendientes')">Exportar</button>
</div>

<table id="tablaPendientes">
<thead>
<tr>
<th>Fecha</th>
<th>ID Sitio</th>
<th>Nombre Sitio</th>
<th>Equipo</th>
<th>Serie</th>
<th>TÃ©cnico</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- ENTREGAS -->
<div class="filter-row">
<input type="text" id="filterSitioEntregas" placeholder="Filtrar Sitio">
<input type="text" id="filterTecnicoEntregas" placeholder="Filtrar TÃ©cnico">
<input type="number" id="filterSemanaEntregas" placeholder="Semana">
</div>

<div class="table-container">
<div class="table-header">
<h2>âœ… Entregas</h2>
<button onclick="exportTableAsImage('tablaEntregados','Entregas')">Exportar</button>
</div>

<table id="tablaEntregados">
<thead>
<tr>
<th>Fecha</th>
<th>ID Sitio</th>
<th>Sitio</th>
<th>Equipo</th>
<th>Serie</th>
<th>Bodega</th>
<th>TÃ©cnico</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<!-- ===================== HISTORIAL ===================== -->
<div id="historial" class="tab-content">

<div class="table-box">

<div class="table-header">
<h2 id="tituloHistorial">ðŸ“œ Historial</h2>
<button onclick="exportHistorialCompleto()">Exportar Mes Completo</button>
</div>

<div id="totalRegistrosMes">Total registros del mes: 0</div>

<div class="filter-row">
<select id="selectorMes"></select>
<select id="selectorAnio"></select>
<input type="text" id="filterSitioHistorial" placeholder="Filtrar Sitio">
<input type="text" id="filterTecnicoHistorial" placeholder="Filtrar TÃ©cnico">
</div>

<table id="tablaHistorial">
<thead>
<tr>
<th>Fecha</th>
<th>ID Sitio</th>
<th>Nombre Sitio</th>
<th>Equipo</th>
<th>Serie</th>
<th>TÃ©cnico</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="paginacion" class="pagination"></div>

</div>
</div>

<script>
const URL_SALIDAS='https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=0&single=true&output=csv';
const URL_ENTREGAS='https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=887165919&single=true&output=csv';

let datosPendientes=[],datosEntregas=[],datosHistorial=[],datosFiltradosMes=[];
let paginaActual=1;
const porPagina=10;

window.onload=()=>{cargarDashboard();cargarHistorial();};

function mostrarTab(id){
document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
document.getElementById(id).classList.add('active');
event.target.classList.add('active');
}

/* === DASHBOARD === */

async function cargarDashboard(){
const [r1,r2]=await Promise.all([fetch(URL_SALIDAS),fetch(URL_ENTREGAS)]);
const t1=await r1.text();
const t2=await r2.text();
procesarPendientes(t1);
procesarEntregados(t2);
document.getElementById('lastUpdate').innerText="Actualizado: "+new Date().toLocaleString();
}

function procesarPendientes(csv){
Papa.parse(csv,{header:false,complete:(res)=>{
const ahora=new Date();
const limite=new Date();limite.setDate(ahora.getDate()-90);
datosPendientes = res.data.filter(f=>{
    const fecha = parseFecha(f[0]);
    return fecha && fecha >= limite && f[9] === 'PENDIENTE';
});
});
document.getElementById('stat-pendientes').innerText=datosPendientes.length;
renderPendientes();
}});
}

function renderPendientes(){
const sf=document.getElementById('filterSitioPendientes').value.toLowerCase();
const tf=document.getElementById('filterTecnicoPendientes').value.toLowerCase();
const tbody=document.querySelector('#tablaPendientes tbody');
tbody.innerHTML=datosPendientes.filter(f=>
f[3].toLowerCase().includes(sf)&&
f[1].toLowerCase().includes(tf)
).map(f=>`
<tr>
<td>${f[0]}</td>
<td>${f[3]}</td>
<td>${f[4]}</td>
<td>${f[5]}</td>
<td>${f[7]}</td>
<td>${f[1]}</td>
</tr>`).join('');
}

function procesarEntregados(csv){
Papa.parse(csv,{header:false,complete:(res)=>{
const hoy=new Date();
const inicioSemana=new Date(hoy);
inicioSemana.setDate(hoy.getDate()-hoy.getDay()+1);
datosEntregas=res.data.filter(f=>{
const fecha=parseFecha(f[0]);
return fecha>=inicioSemana;
});
document.getElementById('stat-semanal').innerText=datosEntregas.length;
renderEntregas();
}});
}

function renderEntregas(){
const sf=document.getElementById('filterSitioEntregas').value.toLowerCase();
const tf=document.getElementById('filterTecnicoEntregas').value.toLowerCase();
const semana=document.getElementById('filterSemanaEntregas').value;
const tbody=document.querySelector('#tablaEntregados tbody');
tbody.innerHTML=datosEntregas.filter(f=>{
const semanaFila=numeroSemana(parseFecha(f[0]));
return f[2].toLowerCase().includes(sf)&&
f[1].toLowerCase().includes(tf)&&
(semana===""||semanaFila==semana);
}).map(f=>`
<tr>
<td>${f[0]}</td>
<td>${f[3]}</td>
<td>${f[2]}</td>
<td>${f[6]}</td>
<td>${f[9]}</td>
<td>${f[8]}</td>
<td>${f[1]}</td>
</tr>`).join('');
}

/* === HISTORIAL === */

function cargarHistorial(){
fetch(URL_SALIDAS)
.then(r=>r.text())
.then(csv=>{
Papa.parse(csv,{header:false,complete:(res)=>{
datosHistorial=res.data;
cargarSelectMes();
cargarSelectAnio();
filtrarPorMes();
}});
});
}

function cargarSelectMes(){
const sel=document.getElementById('selectorMes');
const meses=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
sel.innerHTML=meses.map((m,i)=>`<option value="${i}">${m}</option>`).join('');
sel.value=new Date().getMonth();
}

function cargarSelectAnio(){
const sel=document.getElementById('selectorAnio');
const actual=new Date().getFullYear();
let opciones="";
for(let i=actual;i>=actual-5;i--){
opciones+=`<option value="${i}">${i}</option>`;
}
sel.innerHTML=opciones;
sel.value=actual;
}

function filtrarPorMes(){
const mes=parseInt(document.getElementById('selectorMes').value);
const anio=parseInt(document.getElementById('selectorAnio').value);
datosFiltradosMes = datosHistorial.filter(f=>{
    const fecha = parseFecha(f[0]);
    return fecha && fecha.getMonth() === mes && fecha.getFullYear() === anio;
});
});
document.getElementById('tituloHistorial').innerText="ðŸ“œ Historial - "+(mes+1)+"/"+anio;
document.getElementById('totalRegistrosMes').innerText="Total registros: "+datosFiltradosMes.length;
paginaActual=1;
renderTablaHistorial();
}

function renderTablaHistorial(){
const sf=document.getElementById('filterSitioHistorial').value.toLowerCase();
const tf=document.getElementById('filterTecnicoHistorial').value.toLowerCase();
const filtrados=datosFiltradosMes.filter(f=>
f[3].toLowerCase().includes(sf)&&
f[1].toLowerCase().includes(tf)
);
const inicio=(paginaActual-1)*porPagina;
const pagina=filtrados.slice(inicio,inicio+porPagina);
const tbody=document.querySelector('#tablaHistorial tbody');
tbody.innerHTML=pagina.map(f=>`
<tr>
<td>${f[0]}</td>
<td>${f[3]}</td>
<td>${f[4]}</td>
<td>${f[5]}</td>
<td>${f[7]}</td>
<td>${f[1]}</td>
</tr>`).join('');
renderPaginacion(filtrados.length);
}

function renderPaginacion(total){
const totalPaginas=Math.ceil(total/porPagina);
const cont=document.getElementById('paginacion');
if(totalPaginas<=1){cont.innerHTML="";return;}
let botones="";
for(let i=1;i<=totalPaginas;i++){
botones+=`<button class="${i===paginaActual?'active':''}" onclick="paginaActual=${i};renderTablaHistorial();">${i}</button>`;
}
cont.innerHTML=botones;
}

function exportHistorialCompleto(){
const tabla=document.getElementById('tablaHistorial').cloneNode(true);
tabla.querySelector('tbody').innerHTML=datosFiltradosMes.map(f=>`
<tr>
<td>${f[0]}</td>
<td>${f[3]}</td>
<td>${f[4]}</td>
<td>${f[5]}</td>
<td>${f[7]}</td>
<td>${f[1]}</td>
</tr>`).join('');
const box=document.createElement('div');
box.style.position='fixed';
box.style.top='-10000px';
box.style.background='#fff';
box.style.padding='20px';
box.appendChild(tabla);
document.body.appendChild(box);
html2canvas(box,{scale:2}).then(canvas=>{
const a=document.createElement('a');
a.href=canvas.toDataURL('image/png');
a.download='Historial.png';
a.click();
document.body.removeChild(box);
});
}

/* === UTILS === */

function parseFecha(str){
    if(!str || typeof str !== "string") return null;

    const p = str.split(/[/ :]/);
    if(p.length < 3) return null;

    const fecha = new Date(p[2], p[1]-1, p[0], p[3]||0, p[4]||0, p[5]||0);

    if(isNaN(fecha.getTime())) return null;

    return fecha;
}

function numeroSemana(fecha){
const primerDiaAno=new Date(fecha.getFullYear(),0,1);
const dias=Math.floor((fecha-primerDiaAno)/86400000);
return Math.ceil((dias+primerDiaAno.getDay()+1)/7);
}
</script>

</body>
</html>

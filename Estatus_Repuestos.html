<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Network Ops - Control de Gesti√≥n</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root { --brand: #4f46e5; --bg: #f8fafc; --text: #1e293b; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --dark: #334155; }
body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }

/* Navegaci√≥n y Header */
.header-dash { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
.tab-container { display: flex; gap: 8px; background: #e2e8f0; padding: 5px; border-radius: 12px; }
.tab-btn { padding: 8px 18px; border: none; border-radius: 8px; cursor: pointer; background: transparent; font-weight: 600; font-family: inherit; color: #64748b; transition: 0.3s; }
.tab-btn.active { background: white; color: var(--brand); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

/* Cartas de Trazabilidad */
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
.card-stat { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid var(--brand); }
.card-stat h3 { margin: 0; font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
.card-stat .value { font-size: 1.8rem; font-weight: 600; margin: 5px 0; }

/* Tablas y Contenedores */
.table-container { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 30px; overflow-x: auto; }
.table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; flex-wrap: wrap; gap: 10px; }
.table-header h2 { font-size: 1.1rem; margin: 0; display: flex; align-items: center; gap: 8px; }

table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-weight: 600; }
td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

/* Filtros y Botones */
.filter-group { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; background: #f1f5f9; padding: 12px; border-radius: 12px; }
.filter-group input { padding: 8px 12px; border-radius: 8px; border: 1px solid #cbd5e1; outline: none; font-size: 0.85rem; min-width: 180px; }
button { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit; font-size: 0.85rem; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
.btn-filter { background: var(--dark); color: white; }
.btn-filter:hover { background: #1e293b; }
.btn-clear { background: #e2e8f0; color: #475569; }
.btn-export { background: var(--brand); color: white; }

.badge { padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
.badge-pending { background: #fee2e2; color: #991b1b; }
.badge-success { background: #dcfce7; color: #166534; }

footer { text-align:center; padding:20px 0; font-size:0.8rem; color:#64748b; border-top:1px solid #e2e8f0; }

@media print { .tab-container, .filter-group, button, #lastUpdate { display: none !important; } }
</style>
</head>
<body>

<div class="header-dash">
    <div>
        <h1 style="margin:0; font-size: 1.6rem;">CONTROL DE REPUESTOS</h1>
        <div id="lastUpdate" style="font-size: 0.75rem; color: #64748b;">Iniciando sistema...</div>
    </div>
    <nav class="tab-container">
        <button class="tab-btn active" onclick="openTab('dashboard')">üìä Dashboard</button>
        <button class="tab-btn" onclick="openTab('historial')">üìú Historial Mensual</button>
    </nav>
</div>

<div id="tab-dashboard" class="tab-content">
    
    <div class="stats-row">
        <div class="card-stat">
            <h3>Total Pendientes</h3>
            <div class="value" id="stat-pendientes">0</div>
        </div>
        <div class="card-stat" style="border-left-color: var(--warning);">
            <h3>Alerta (7-15 d√≠as)</h3>
            <div class="value" id="stat-alerta">0</div>
        </div>
        <div class="card-stat" style="border-left-color: var(--danger);">
            <h3>Cr√≠ticos (+15 d√≠as)</h3>
            <div class="value" id="stat-critico">0</div>
        </div>
        <div class="card-stat" style="border-left-color: var(--success);">
            <h3>Eficiencia de Retorno</h3>
            <div class="value" id="stat-eficiencia">0%</div>
            <div style="width: 100%; background: #e2e8f0; height: 6px; border-radius: 3px; margin-top: 8px;">
                <div id="bar-eficiencia" style="width: 0%; background: var(--success); height: 100%; border-radius: 3px; transition: 1s ease;"></div>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="table-header">
            <h2>üìã Salidas Pendientes de Entrega</h2>
            <button class="btn-export" onclick="exportTableAsImage('tablaPendientes', 'Pendientes')">üì∏ Capturar Tabla</button>
        </div>
        
        <div class="filter-group">
            <input type="text" id="fSitioP" placeholder="ID o Nombre de Sitio">
            <input type="text" id="fTecP" placeholder="Nombre del T√©cnico">
            <button class="btn-filter" onclick="renderPendientes()">üîç Filtrar</button>
            <button class="btn-clear" onclick="clearFilters('P')">üîÑ Limpiar</button>
        </div>

        <table id="tablaPendientes">
            <thead>
                <tr>
                    <th>Fecha Salida</th>
                    <th>ID Sitio</th>
                    <th>Nombre Sitio</th>
                    <th>Equipo</th>
                    <th>Serie</th>
                    <th>T√©cnico</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="table-container">
        <div class="table-header">
            <h2>‚úÖ Entregas Realizadas (Semana Actual)</h2>
            <button class="btn-export" onclick="exportTableAsImage('tablaEntregados', 'Entregas_Semana')">üì∏ Capturar Tabla</button>
        </div>

        <div class="filter-group">
            <input type="text" id="fSitioE" placeholder="Sitio...">
            <input type="number" id="fSemE" placeholder="N¬∞ de Semana">
            <button class="btn-filter" onclick="renderEntregas()">üîç Filtrar</button>
            <button class="btn-clear" onclick="clearFilters('E')">üîÑ Limpiar</button>
        </div>

        <table id="tablaEntregados">
            <thead>
                <tr>
                    <th>Fecha Entrega</th>
                    <th>ID Sitio</th>
                    <th>Sitio</th>
                    <th>Equipo</th>
                    <th>Serie</th>
                    <th>Bodega</th>
                    <th>T√©cnico</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="tab-historial" class="tab-content" style="display:none;">
    <div class="table-container">
        <div class="table-header">
            <h2>üìú Historial General de Movimientos</h2>
            <div style="display: flex; gap: 8px;">
                <button onclick="exportarHistorialExcel()" style="background: #166534; color: white;">üìä Excel</button>
                <button onclick="window.print()" style="background: #991b1b; color: white;">üìÑ PDF</button>
            </div>
        </div>

        <div class="filter-group">
            <label style="font-weight:600;">Seleccionar Mes:</label>
            <input type="month" id="fMesH">
            <button class="btn-filter" onclick="renderHistorial()">üîç Ver Historial</button>
        </div>

        <table id="tablaHistorial">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>ID Sitio</th>
                    <th>Sitio</th>
                    <th>Equipo</th>
                    <th>Serie</th>
                    <th>T√©cnico</th>
                    <th>Estado Final</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<footer>
    Dashboard de Trazabilidad | <strong>Operaciones Paracentrales</strong> | &copy; 2026
</footer>

<script>
const URL_SALIDAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=0&single=true&output=csv';
const URL_ENTREGAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=887165919&single=true&output=csv';

let datosP = [], datosE = [], todasSalidas = [];

async function cargarDatos() {
    try {
        const [rSal, rEnt] = await Promise.all([fetch(URL_SALIDAS), fetch(URL_ENTREGAS)]);
        const tSal = await rSal.text();
        const tEnt = await rEnt.text();
        
        Papa.parse(tSal, { header:false, complete:(res)=>{
            todasSalidas = res.data;
            const hoy = new Date();
            const limite = new Date(); limite.setDate(hoy.getDate() - 90);
            datosP = res.data.filter(f => parseFecha(f[0]) >= limite && f[9] === 'PENDIENTE');
            document.getElementById('fMesH').value = hoy.toISOString().substring(0, 7);
            renderPendientes();
            actualizarKpis();
        }});

        Papa.parse(tEnt, { header:false, complete:(res)=>{
            const hoy = new Date();
            const lunes = new Date(hoy); lunes.setDate(hoy.getDate() - (hoy.getDay() || 7) + 1); lunes.setHours(0,0,0,0);
            datosE = res.data.filter(f => parseFecha(f[0]) >= lunes);
            renderEntregas();
            actualizarKpis();
        }});

        document.getElementById('lastUpdate').innerText = "Sincronizado: " + new Date().toLocaleString();
    } catch(e) { console.error(e); }
}

function actualizarKpis() {
    const ahora = new Date();
    let alerta = 0, critico = 0;
    datosP.forEach(f => {
        const d = Math.floor((ahora - parseFecha(f[0])) / 86400000);
        if(d > 15) critico++; else if(d > 7) alerta++;
    });
    document.getElementById('stat-pendientes').innerText = datosP.length;
    document.getElementById('stat-alerta').innerText = alerta;
    document.getElementById('stat-critico').innerText = critico;
    const total = datosP.length + datosE.length;
    const ef = total > 0 ? Math.round((datosE.length / total) * 100) : 0;
    document.getElementById('stat-eficiencia').innerText = ef + "%";
    document.getElementById('bar-eficiencia').style.width = ef + "%";
}

function renderPendientes() {
    const s = document.getElementById('fSitioP').value.toLowerCase();
    const t = document.getElementById('fTecP').value.toLowerCase();
    document.querySelector('#tablaPendientes tbody').innerHTML = datosP.filter(f => 
        (f[3].toLowerCase().includes(s) || f[4].toLowerCase().includes(s)) && f[1].toLowerCase().includes(t)
    ).map(f => `<tr><td>${f[0]}</td><td>${f[3]}</td><td>${f[4]}</td><td>${f[5]}</td><td>${f[7]}</td><td>${f[1]}</td></tr>`).join('');
}

function renderEntregas() {
    const s = document.getElementById('fSitioE').value.toLowerCase();
    const sem = document.getElementById('fSemE').value;
    document.querySelector('#tablaEntregados tbody').innerHTML = datosE.filter(f => {
        return f[2].toLowerCase().includes(s) && (sem === "" || getSemana(parseFecha(f[0])) == sem);
    }).map(f => `<tr><td>${f[0]}</td><td>${f[3]}</td><td>${f[2]}</td><td>${f[6]}</td><td>${f[9]}</td><td>${f[8]}</td><td>${f[1]}</td></tr>`).join('');
}

function renderHistorial() {
    const mes = document.getElementById('fMesH').value;
    document.querySelector('#tablaHistorial tbody').innerHTML = todasSalidas.filter(f => {
        const d = parseFecha(f[0]);
        return d && (d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0')) === mes;
    }).map(f => `<tr><td>${f[0]}</td><td>${f[3]}</td><td>${f[4]}</td><td>${f[5]}</td><td>${f[7]}</td><td>${f[1]}</td><td><span class="badge ${f[9]==='PENDIENTE'?'badge-pending':'badge-success'}">${f[9]}</span></td></tr>`).join('');
}

function clearFilters(tipo) {
    if(tipo === 'P') { document.getElementById('fSitioP').value = ""; document.getElementById('fTecP').value = ""; renderPendientes(); }
    else { document.getElementById('fSitioE').value = ""; document.getElementById('fSemE').value = ""; renderEntregas(); }
}

function openTab(name) {
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + name).style.display = 'block';
    event.currentTarget.classList.add('active');
    if(name === 'historial') renderHistorial();
}

function parseFecha(str) { if(!str) return null; const p = str.split(/[/ :]/); return new Date(p[2], p[1]-1, p[0], p[3]||0, p[4]||0); }

function getSemana(d) { const p = new Date(d.getFullYear(),0,1); return Math.ceil((((d-p)/86400000)+p.getDay()+1)/7); }

function exportTableAsImage(id, n) {
    html2canvas(document.getElementById(id).closest('.table-container'), { scale:2 }).then(canvas => {
        const a = document.createElement('a'); a.href = canvas.toDataURL(); a.download = n + '.png'; a.click();
    });
}

function exportarHistorialExcel() {
    let csv = "\uFEFFFecha;ID Sitio;Sitio;Equipo;Serie;Tecnico;Estado\n";
    document.querySelectorAll("#tablaHistorial tbody tr").forEach(tr => {
        csv += Array.from(tr.querySelectorAll("td")).map(td => td.innerText).join(";") + "\n";
    });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
    a.download = `Historial_${document.getElementById('fMesH').value}.csv`;
    a.click();
}

window.onload = cargarDatos;
</script>
</body>
</html>

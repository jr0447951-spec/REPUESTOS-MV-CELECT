<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Network Ops - Control de GestiÃ³n</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<style>
:root { --brand: #4f46e5; --bg: #f8fafc; --text: #1e293b; --danger: #ef4444; --success: #10b981; }
body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
.header-dash { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.card-stat { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid var(--brand); }
.card-stat h3 { margin: 0; font-size: 0.8rem; color: #64748b; text-transform: uppercase; }
.card-stat .value { font-size: 1.8rem; font-weight: 600; color: var(--brand); }
.table-container { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 30px; overflow-x: auto; }
.table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
.table-header h2 { font-size: 1.1rem; margin: 0; }
table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-weight: 600; }
td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
.badge { padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
.badge-pending { background: #fee2e2; color: #991b1b; }
.badge-success { background: #dcfce7; color: #166534; }
.table-filters { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
.table-filters label { font-size: 0.85rem; }
.table-filters input { padding: 4px 6px; border-radius: 4px; border: 1px solid #cbd5e1; }
</style>
</head>
<body>

<div class="header-dash">
    <h1>Dashboard Operativo</h1>
    <div id="lastUpdate" style="font-size: 0.8rem; color: #64748b;">Actualizando...</div>
</div>

<div class="stats-row">
    <div class="card-stat">
        <h3>Pendientes (3 Meses)</h3>
        <div class="value" id="stat-pendientes">0</div>
    </div>
    <div class="card-stat" style="border-left-color: var(--success);">
        <h3>Entregados (Semana)</h3>
        <div class="value" id="stat-semanal">0</div>
    </div>
</div>

<div class="table-container">
    <div class="table-header">
        <h2>ðŸ“‹ Pendientes de GestiÃ³n (Ãšltimos 90 dÃ­as)</h2>
        <span class="badge badge-pending" id="tag-pendientes">Total: 0</span>
    </div>
    <div class="table-filters">
        <label>Sitio: <input type="text" id="filterSitioPendientes" placeholder="Filtrar por Sitio"></label>
        <label>TÃ©cnico: <input type="text" id="filterTecnicoPendientes" placeholder="Filtrar por TÃ©cnico"></label>
    </div>
    <table id="tablaPendientes">
        <thead>
            <tr>
                <th>Fecha Salida</th>
                <th>ID Sitio</th>
                <th>Nombre Sitio</th>
                <th>Equipo</th>
                <th>Serie</th>
                <th>TÃ©cnico</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="table-container">
    <div class="table-header">
        <h2>âœ… Entregas Realizadas (Semana)</h2>
        <span class="badge badge-success" id="tag-semanal">Semana Actual</span>
    </div>
    <div class="table-filters">
        <label>Sitio: <input type="text" id="filterSitioEntregas" placeholder="Filtrar por Sitio"></label>
        <label>TÃ©cnico: <input type="text" id="filterTecnicoEntregas" placeholder="Filtrar por TÃ©cnico"></label>
        <label>Semana: <input type="number" id="filterSemanaEntregas" placeholder="NÃºmero de Semana"></label>
    </div>
    <table id="tablaEntregados">
        <thead>
            <tr>
                <th>Fecha Entrega</th>
                <th>ID Sitio</th>
                <th>Sitio</th>
                <th>Nombre de Equipo</th>
                <th>Serie</th>
                <th>Bodega</th>
                <th>TÃ©cnico</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
// SALIDA DE EQUIPOS (Pendientes)
// SALIDA DE EQUIPOS (Pendientes)
const URL_SALIDAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=0&output=csv';

// ENTREGA DE EQUIPOS (Entregas)
const URL_ENTREGAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?gid=887165919&single=true&output=csv';




let datosPendientes = [];
let datosEntregas = [];

function parseFechaElSalvador(fechaStr) {
    const [fecha, hora] = fechaStr.split(' ');
    const [dia, mes, anio] = fecha.split('/').map(Number);
    const [hh, mm, ss] = hora.split(':').map(Number);
    return new Date(Date.UTC(anio, mes-1, dia, hh+6, mm, ss));
}

function inicioSemana(fecha) {
    const d = new Date(fecha);
    const dia = d.getDay();
    const diff = dia === 0 ? -6 : 1 - dia;
    d.setDate(d.getDate() + diff);
    d.setHours(0,0,0,0);
    return d;
}

function finSemana(fecha) {
    const d = inicioSemana(fecha);
    d.setDate(d.getDate() + 6);
    d.setHours(23,59,59,999);
    return d;
}

function numeroSemana(fecha) {
    const d = new Date(Date.UTC(fecha.getFullYear(), fecha.getMonth(), fecha.getDate()));
    const diaSemana = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - diaSemana);
    const aÃ±oInicio = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - aÃ±oInicio)/86400000) +1)/7);
}

async function cargarDashboard() {
    try {
        const [respSalidas, respEntregas] = await Promise.all([
            fetch(URL_SALIDAS), fetch(URL_ENTREGAS)
        ]);

        const textoSalidas = await respSalidas.text();
        const textoEntregas = await respEntregas.text();

        procesarPendientes(textoSalidas);
        procesarEntregados(textoEntregas);

        document.getElementById('lastUpdate').innerText = "Ãšltima actualizaciÃ³n: " + new Date().toLocaleString();
    } catch (e) {
        console.error("Error al cargar datos", e);
    }
}

function procesarPendientes(csv) {
    Papa.parse(csv, { header: false, complete: (results) => {
        const ahora = new Date();
        const limite90 = new Date(); limite90.setDate(ahora.getDate() - 90); limite90.setHours(0,0,0,0);

        datosPendientes = results.data.filter(f => {
            if (!f[0] || !f[9]) return false;
            const fecha = parseFechaElSalvador(f[0]);
            return fecha >= limite90 && f[9].trim().toUpperCase() === 'PENDIENTE';
        });

        document.getElementById('stat-pendientes').innerText = datosPendientes.length;
        document.getElementById('tag-pendientes').innerText = "Total: " + datosPendientes.length;

        aplicarFiltroPendientes();
    }});
}

function procesarEntregados(csv) {
    Papa.parse(csv, { header: false, complete: (results) => {
        const hoy = new Date();
        const inicio = inicioSemana(hoy);
        const fin = finSemana(hoy);
        const numSemana = numeroSemana(hoy);

        datosEntregas = results.data.filter(f => {
            if (!f[0]) return false;
            const fecha = parseFechaElSalvador(f[0]);
            return fecha >= inicio && fecha <= fin;
        });

        document.getElementById('stat-semanal').innerText = datosEntregas.length;
        document.getElementById('tag-semanal').innerText = `Semana ${numSemana}`;
        document.querySelector('#tablaEntregados').closest('.table-container')
            .querySelector('.table-header h2')
            .innerText = `âœ… Entregas Realizadas (Semana ${numSemana})`;

        aplicarFiltroEntregas();
    }});
}

function aplicarFiltroPendientes() {
    const sitio = document.getElementById('filterSitioPendientes').value.toLowerCase();
    const tecnico = document.getElementById('filterTecnicoPendientes').value.toLowerCase();

    const tbody = document.querySelector('#tablaPendientes tbody');
    tbody.innerHTML = datosPendientes.filter(f =>
        f[4].toLowerCase().includes(sitio) &&
        f[1].toLowerCase().includes(tecnico)
    ).map(f => `
        <tr>
            <td>${f[0]}</td>
            <td>${f[3]}</td>
            <td>${f[4]}</td>
            <td>${f[5]}</td>
            <td>${f[7]}</td>
            <td>${f[1]}</td>
        </tr>
    `).join('');
}

function aplicarFiltroEntregas() {
    const sitio = document.getElementById('filterSitioEntregas').value.toLowerCase();
    const tecnico = document.getElementById('filterTecnicoEntregas').value.toLowerCase();
    const semana = document.getElementById('filterSemanaEntregas').value;

    const tbody = document.querySelector('#tablaEntregados tbody');
    tbody.innerHTML = datosEntregas.filter(f => {
        const numSemanaFila = numeroSemana(parseFechaElSalvador(f[0]));
        return f[2].toLowerCase().includes(sitio) &&
               f[1].toLowerCase().includes(tecnico) &&
               (semana === "" || numSemanaFila == semana);
    }).map(f => `
        <tr>
            <td>${f[0]}</td>   <!-- Fecha Entrega -->
            <td>${f[3]}</td>   <!-- ID Sitio -->
            <td>${f[2]}</td>   <!-- Sitio -->
            <td>${f[6]}</td>   <!-- Nombre de Equipo -->
            <td>${f[9]}</td>   <!-- Serie -->
            <td>${f[8]}</td>   <!-- Bodega CORREGIDO -->
            <td>${f[1]}</td>   <!-- TÃ©cnico -->
        </tr>
    `).join('');
}


// Eventos de filtros
document.getElementById('filterSitioPendientes').addEventListener('input', aplicarFiltroPendientes);
document.getElementById('filterTecnicoPendientes').addEventListener('input', aplicarFiltroPendientes);
document.getElementById('filterSitioEntregas').addEventListener('input', aplicarFiltroEntregas);
document.getElementById('filterTecnicoEntregas').addEventListener('input', aplicarFiltroEntregas);
document.getElementById('filterSemanaEntregas').addEventListener('input', aplicarFiltroEntregas);

// Cargar al iniciar y actualizar cada 5 minutos
window.onload = () => {
    cargarDashboard();
    setInterval(cargarDashboard, 300000);
};
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Network Ops - Control de GestiÃ³n</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --brand: #4f46e5; --bg: #f8fafc; --text: #1e293b; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .header-dash { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .card-stat { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid var(--brand); }
        .card-stat h3 { margin: 0; font-size: 0.8rem; color: #64748b; text-transform: uppercase; }
        .card-stat .value { font-size: 1.8rem; font-weight: 600; color: var(--brand); }

        .table-container { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 30px; overflow-x: auto; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .table-header h2 { font-size: 1.1rem; margin: 0; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        .badge-pending { background: #fee2e2; color: #991b1b; }
        .badge-success { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

<div class="header-dash">
    <h1>Dashboard Operativo</h1>
    <div id="lastUpdate" style="font-size: 0.8rem; color: #64748b;">Actualizando...</div>
</div>

<div class="stats-row">
    <div class="card-stat">
        <h3>Pendientes (3 Meses)</h3>
        <div class="value" id="stat-pendientes">0</div>
    </div>
    <div class="card-stat" style="border-left-color: var(--success);">
        <h3>Entregados (Semana)</h3>
        <div class="value" id="stat-semanal">0</div>
    </div>
</div>

<div class="table-container">
    <div class="table-header">
        <h2>ðŸ“‹ Pendientes de GestiÃ³n (Ãšltimos 90 dÃ­as)</h2>
        <span class="badge badge-pending" id="tag-pendientes">Total: 0</span>
    </div>
    <table id="tablaPendientes">
        <thead>
            <tr>
                <th>Fecha Salida</th>
                <th>TÃ©cnico</th>
                <th>ID Sitio</th>
                <th>Equipo</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="table-container">
    <div class="table-header">
        <h2>âœ… Entregas Realizadas (Esta Semana)</h2>
        <span class="badge badge-success" id="tag-semanal">Semana Actual</span>
    </div>
    <table id="tablaEntregados">
        <thead>
            <tr>
                <th>Fecha Entrega</th>
                <th>TÃ©cnico</th>
                <th>Sitio</th>
                <th>Serie Ingresada</th>
                <th>Foto</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const URL_SALIDAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?output=csv';
    const URL_ENTREGAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_5CZtD7qHGW5cWHGAjn7ALTphVm5h88lco9cySYoAe2VBW4fq8DQ7-SZY6cd_FHtNQJS3MpE88hs/pub?gid=0&output=csv';

    async function cargarDashboard() {
        try {
            const [respSalidas, respEntregas] = await Promise.all([
                fetch(URL_SALIDAS), fetch(URL_ENTREGAS)
            ]);
            
            const textoSalidas = await respSalidas.text();
            const textoEntregas = await respEntregas.text();

            procesarPendientes(textoSalidas);
            procesarEntregados(textoEntregas);
            
            document.getElementById('lastUpdate').innerText = "Ãšltima actualizaciÃ³n: " + new Date().toLocaleString();
        } catch (e) { console.error("Error al cargar datos", e); }
    }

    function procesarPendientes(csv) {
        Papa.parse(csv, {
            header: false,
            complete: (results) => {
                const ahora = new Date();
                const limite90 = ahora.setDate(ahora.getDate() - 90);
                
                const datos = results.data.filter(fila => {
                    const fecha = new Date(fila[0]); // Columna A: Fecha
                    return fecha >= limite90 && fila[9] === 'PENDIENTE'; // Columna J: Estatus
                });

                document.getElementById('stat-pendientes').innerText = datos.length;
                const tbody = document.querySelector('#tablaPendientes tbody');
                tbody.innerHTML = datos.map(f => `
                    <tr>
                        <td>${f[0]}</td>
                        <td>${f[1]}</td>
                        <td>${f[3]}</td>
                        <td>${f[5]}</td>
                        <td><span class="badge badge-pending">${f[9]}</span></td>
                    </tr>
                `).join('');
            }
        });
    }

    function procesarEntregados(csv) {
        Papa.parse(csv, {
            header: false,
            complete: (results) => {
                const hoy = new Date();
                const inicioSemana = new Date(hoy.setDate(hoy.getDate() - hoy.getDay())); // Domingo
                
                const datos = results.data.filter(fila => {
                    const fecha = new Date(fila[0]); // Columna A: Fecha de ingreso
                    return fecha >= inicioSemana;
                });

                document.getElementById('stat-semanal').innerText = datos.length;
                const tbody = document.querySelector('#tablaEntregados tbody');
                tbody.innerHTML = datos.map(f => `
                    <tr>
                        <td>${f[0]}</td>
                        <td>${f[1]}</td>
                        <td>${f[3]}</td>
                        <td>${f[8]}</td>
                        <td><a href="${f[11]}" target="_blank">ðŸ“¸ Ver</a></td>
                    </tr>
                `).join('');
            }
        });
    }

    window.onload = cargarDashboard;
</script>
</body>
</html>

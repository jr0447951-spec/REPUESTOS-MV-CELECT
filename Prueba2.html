<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Repuestos Go! - Registro Optimizado</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<style>
:root {
    --brand: #4f46e5;
    --brand-light: #818cf8;
    --bg: #f8fafc;
    --card-bg: #ffffff;
    --text: #1e293b;
    --success: #10b981;
}
body {
    font-family: 'Poppins', sans-serif;
    background: radial-gradient(circle at top left, #eef2ff 0%, #f8fafc 100%);
    color: var(--text);
    margin:0; padding:0;
    min-height:100vh; display:flex; flex-direction:column;
}
header {
    padding:25px 20px; text-align:center;
    background: var(--card-bg);
    border-bottom-left-radius:30px; border-bottom-right-radius:30px;
    box-shadow:0 4px 20px rgba(0,0,0,0.05);
}
header h1 { margin:0; font-size:1.4rem; color: var(--brand); font-weight:600; letter-spacing:-0.5px; }
.timer-pill { background: var(--brand); color:white; padding:6px 15px; border-radius:20px; font-size:.8rem; font-weight:600; display:inline-block; margin-bottom:15px; box-shadow:0 4px 10px rgba(79,70,229,0.3);}
.container { width:90%; max-width:450px; margin:20px auto; flex:1; }
.card { background: var(--card-bg); border-radius:24px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.03); border:1px solid rgba(255,255,255,0.8); margin-bottom:20px; }
label { display:block; margin-top:15px; font-size:.75rem; font-weight:600; color:#64748b; margin-left:5px; }
.bodega-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:8px; }
.btn-bodega { background:#f1f5f9; border:2px solid transparent; padding:12px 5px; border-radius:16px; font-size:.7rem; font-weight:600; color:#475569; cursor:pointer; transition:all .2s cubic-bezier(0.175,0.885,0.32,1.275);}
.btn-bodega.selected { background:#fff; border-color:var(--brand); color:var(--brand); transform:scale(1.05); box-shadow:0 8px 15px rgba(79,70,229,0.15);}
input { width:100%; padding:14px; margin-top:6px; border-radius:16px; border:1.5px solid #e2e8f0; background:#f8fafc; color:var(--text); font-size:1rem; outline:none; transition:.3s; box-sizing:border-box; }
input:focus { border-color:var(--brand-light); background:#fff; box-shadow:0 0 0 4px rgba(79,70,229,.1);}
.readonly { background:#f1f5f9; color:#94a3b8; border-style:none; font-size:.9rem;}
.suggestions { position:absolute; width:100%; background:#fff; border-radius:16px; box-shadow:0 15px 35px rgba(0,0,0,.1); z-index:100; display:none; margin-top:5px; border:1px solid #e2e8f0; overflow:hidden; max-height:200px; overflow-y:auto;}
.suggestion-item { padding:10px 15px; border-bottom:1px solid #f1f5f9; font-size:.9rem; cursor:pointer; }
.suggestion-item:active { background:#f1f5f9;}
.btn-send { width:100%; padding:18px; border-radius:18px; background:linear-gradient(135deg,var(--brand),var(--brand-light)); color:white; border:none; font-weight:600; font-size:1rem; margin-top:30px; box-shadow:0 10px 20px rgba(79,70,229,.2); cursor:pointer; transition:.3s;}
.btn-send:active { transform:scale(.96);}
.hidden { display:none; }
#previewFoto { margin-top:10px; width:100%; border-radius:16px; max-height:300px; object-fit:contain; display:none; border:1px solid #cbd5e1;}
</style>
</head>
<body>

<header>
    <div class="timer-pill" id="reloj">00:00:00</div>
    <h1>Registro de Salida</h1>
</header>

<div class="container">
    <div class="card" id="consentimiento" style="text-align:center;">
        <div style="font-size:3rem; margin-bottom:10px;">üì¶</div>
        <h2 style="font-size:1.2rem; margin-bottom:10px;">¬°Hola!</h2>
        <p style="color:#64748b; font-size:.9rem; line-height:1.5;">Para registrar un repuesto necesitamos acceso para guardar tu foto de evidencia.</p>
        <button onclick="activar()" id="btnStart" disabled class="btn-send" style="background:#94a3b8;">Cargando inventario...</button>
        <div id="load-info">Sincronizando repuestos 2026...</div>
    </div>

    <form id="mainForm" class="hidden">
        <div class="card">
            <label>Nombre del T√©cnico</label>
            <input type="text" id="tecnico" placeholder="Nombre + Apellido" required autocomplete="off">
            <div id="tecnicoSug" class="suggestions"></div>

            <label>¬øDesde qu√© bodega retiras?</label>
            <div class="bodega-grid">
                <button type="button" class="btn-bodega" onclick="selectB(this,'SAN BENITO')">San Benito</button>
                <button type="button" class="btn-bodega" onclick="selectB(this,'BODEGA CENTRAL')">Central</button>
                <button type="button" class="btn-bodega" onclick="selectB(this,'TALNIQUE')">Talnique</button>
            </div>
            <input type="hidden" id="bodega" required>

            <div style="position:relative">
                <label>Nombre del Sitio</label>
                <input type="text" id="siteSearch" placeholder="Selecciona desde la lista..." autocomplete="off" required>
                <div id="siteSug" class="suggestions"></div>
            </div>
            <input type="text" id="idSitio" class="readonly" placeholder="ID autom√°tico" readonly required>

            <div style="position:relative">
                <label>¬øQu√© repuesto llevas?</label>
                <input type="text" id="eqSearch" placeholder="Selecciona desde la lista..." autocomplete="off" required>
                <div id="eqSug" class="suggestions"></div>
            </div>
            <input type="text" id="marca" class="readonly" placeholder="Marca" readonly required>

            <label>N√∫mero de Serie</label>
            <input type="text" id="serie" placeholder="Escanea o escribe S/N" required>

            <label>Foto de la pieza</label>
            <input type="file" id="foto" accept="image/*" required>
            <img id="previewFoto">

            <button type="submit" id="btnEnviar" class="btn-send">FINALIZAR REGISTRO</button>
        </div>
    </form>
</div>

<script>
const CONFIG = {
    URL_SITIOS_CSV: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_5CZtD7qHGW5cWHGAjn7ALTphVm5h88lco9cySYoAe2VBW4fq8DQ7-SZY6cd_FHtNQJS3MpE88hs/pub?gid=1955381502&single=true&output=csv',
    URL_TECNICOS_CSV: 'tecnicos.csv', // <-- tu CSV local con nombre y apellido
    URL_APPS_SCRIPT: 'https://script.google.com/macros/s/AKfycbz_Wv6DikTWQuqnAd9gMrjfEoFOFa9E9YdUuY5cSkr4ICqBKOo5WPvmJrhYF5_dv5fa/exec',
    URL_FORMS_EXTERNO: 'https://docs.google.com/forms/d/e/1FAIpQLSdeek133oAtejD-fC1LPvFPDHiej3l0tokNW9N31LdHFpS06g/viewform'
};

let sites=[], equipos=[], tecnicos=[];

// Reloj
setInterval(()=>{ 
    document.getElementById('reloj').innerText = new Date().toLocaleTimeString("es-SV",{timeZone:"America/El_Salvador", hour12:false}); 
},1000);

window.onload = ()=>{

    // Cargar t√©cnicos
    fetch(CONFIG.URL_TECNICOS_CSV).then(r=>r.text()).then(t=>{
        tecnicos = t.split(/\r?\n/).filter(x=>x.trim()!=='').map(x=>({nombre:x.trim()}));
        document.getElementById('btnStart').disabled=false;
        document.getElementById('btnStart').style.background="var(--brand)";
        document.getElementById('btnStart').innerText="¬°EMPEZAR!";
        document.getElementById('load-info').innerText="Inventario sincronizado";
    });

    // Cargar Sitios
    fetch(CONFIG.URL_SITIOS_CSV).then(r=>r.text()).then(t=>{
        sites = parseCSV(t);
    });

    // Cargar inventario de repuestos
    Papa.parse("inventario_repuestos.csv", {
        download:true, header:true, delimiter:";", skipEmptyLines:true,
        complete: function(res){ equipos=res.data; }
    });
};

// ---------------- CSV Parsing ----------------
function parseCSV(d){
    const r=d.split(/\r?\n/).filter(x=>x.trim().length>0);
    const h=r[0].split(',').map(x=>x.trim().replace(/"/g,''));
    return r.slice(1).map(row=>{
        const v=row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        let o={}; h.forEach((k,i)=> o[k]=v[i]?v[i].trim().replace(/"/g,''):''); return o;
    });
}

// ---------------- Bodega ----------------
function selectB(btn,v){
    document.querySelectorAll('.btn-bodega').forEach(x=>x.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById('bodega').value=v;
}

// ---------------- Activar formulario ----------------
function activar(){
    document.getElementById('consentimiento').classList.add('hidden');
    document.getElementById('mainForm').classList.remove('hidden');
}

// ---------------- Autocomplete gen√©rico ----------------
function setupAutocomplete(inputEl, suggestionsEl, items, displayKey, valueKey){
    inputEl.addEventListener('input', ()=>{
        const val = inputEl.value.toLowerCase().trim();
        suggestionsEl.innerHTML='';
        if(!val){ suggestionsEl.style.display='none'; return; }

        const matches = items.filter(i=> i[displayKey].toLowerCase().includes(val));
        if(matches.length===0){ suggestionsEl.style.display='none'; return; }

        matches.forEach(item=>{
            const div = document.createElement('div');
            div.className='suggestion-item';
            div.textContent=item[displayKey];
            div.addEventListener('click', ()=>{
                inputEl.value = item[displayKey];
                if(valueKey) document.getElementById(valueKey).value = item[valueKey]||'';
                suggestionsEl.style.display='none';
            });
            suggestionsEl.appendChild(div);
        });
        suggestionsEl.style.display='block';
    });

    document.addEventListener('click', e=>{
        if(!inputEl.contains(e.target) && !suggestionsEl.contains(e.target)){
            suggestionsEl.style.display='none';
        }
    });
}

// --- Configurar autocompletado ---
setupAutocomplete(document.getElementById('tecnico'), document.getElementById('tecnicoSug'), tecnicos, 'nombre', null);
setupAutocomplete(document.getElementById('siteSearch'), document.getElementById('siteSug'), sites, 'NOMBRE DE SITIO', 'SITEID');
setupAutocomplete(document.getElementById('eqSearch'), document.getElementById('eqSug'), equipos, 'DESCRIPCION DE EQUIPO', 'marca');

// ---------------- Foto + compresi√≥n ----------------
const fotoInput = document.getElementById("foto");
const preview = document.getElementById("previewFoto");
fotoInput.addEventListener("change", ()=>{
    if(fotoInput.files && fotoInput.files[0]){
        const file = fotoInput.files[0];
        const reader = new FileReader();
        reader.onload = e=>{
            const img = new Image();
            img.onload = ()=>{
                const canvas = document.createElement("canvas");
                const maxSide = 1000;
                let width=img.width, height=img.height;
                if(width>height && width>maxSide){ height*=maxSide/width; width=maxSide;}
                else if(height>=width && height>maxSide){ width*=maxSide/height; height=maxSide;}
                canvas.width=width; canvas.height=height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img,0,0,width,height);
                const compressed = canvas.toDataURL("image/jpeg",0.7);
                preview.src = compressed; preview.style.display="block";
                fotoInput.dataset.compressed = compressed.split(',')[1];
                fotoInput.dataset.mime = "image/jpeg";
                fotoInput.dataset.filename = file.name.replace(/\.[^/.]+$/,".jpg");
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display="none"; preview.src="";
        delete fotoInput.dataset.compressed; delete fotoInput.dataset.mime; delete fotoInput.dataset.filename;
    }
});

// ---------------- Env√≠o ----------------
document.getElementById('mainForm').onsubmit = async e=>{
    e.preventDefault();
    const b = document.getElementById('btnEnviar');
    const valTecnico = document.getElementById('tecnico').value;
    const valBodega = document.getElementById('bodega').value;
    const valIdSitio = document.getElementById('idSitio').value;
    const valSerie = document.getElementById('serie').value;
    const valMarca = document.getElementById('marca').value;
    const valNombreSitio = document.getElementById('siteSearch').value;
    const valDescripcion = document.getElementById('eqSearch').value;

    if(!valBodega){ alert("Selecciona una bodega"); return;}
    if(!fotoInput.dataset.compressed){ alert("Agrega una foto"); return;}

    localStorage.setItem('tecnico', valTecnico);

    b.disabled=true; b.innerText="Subiendo datos...";
    try{
        const p = {
            tecnico: valTecnico,
            bodega: valBodega,
            idSitio: valIdSitio,
            nombreSitio: valNombreSitio,
            descripcion: valDescripcion,
            marca: valMarca,
            serie: valSerie,
            fileData: fotoInput.dataset.compressed,
            fileName: fotoInput.dataset.filename,
            mimeType: fotoInput.dataset.mime
        };
        const r = await fetch(CONFIG.URL_APPS_SCRIPT,{method:"POST", body:new URLSearchParams(p)});
        const res = await r.json();
        if(res.result==="success"){
            const urlFinal = `${CONFIG.URL_FORMS_EXTERNO}?entry.1637897291=CELECT`+
                `&entry.795516044=${encodeURIComponent(valBodega)}`+
                `&entry.1265319450=${encodeURIComponent(valIdSitio)}`+
                `&entry.1509520939=${encodeURIComponent(valNombreSitio)}`+
                `&entry.554570123=${encodeURIComponent(valMarca)}`+
                `&entry.1914147166=${encodeURIComponent(valDescripcion)}`+
                `&entry.1497572830=${encodeURIComponent(valSerie)}`+
                `&entry.733439703=${encodeURIComponent(res.fileUrl)}`;
            window.location.href = urlFinal;
        }
    }catch(x){ alert("Error de conexi√≥n"); b.disabled=false; b.innerText="REINTENTAR ENV√çO";}
};
</script>
</body>
</html>

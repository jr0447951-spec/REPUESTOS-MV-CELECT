<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Repuestos Go! - Registro Validado</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<style>
    :root { --brand: #4f46e5; --brand-light: #818cf8; --bg: #f8fafc; --card-bg: #ffffff; --text: #1e293b; --error: #ef4444; }
    body { font-family: 'Poppins', sans-serif; background: #f8fafc; color: var(--text); margin:0; padding:0; }
    header { padding:20px; text-align:center; background: var(--card-bg); border-bottom: 1px solid #e2e8f0; }
    header h1 { margin:0; font-size:1.2rem; color: var(--brand); }
    .container { width:92%; max-width:450px; margin:15px auto; }
    .card { background: var(--card-bg); border-radius:20px; padding:20px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom:15px; }
    label { display:block; margin-top:12px; font-size:.7rem; font-weight:600; color:#64748b; text-transform: uppercase; }
    input { width:100%; padding:12px; margin-top:5px; border-radius:10px; border:1.5px solid #e2e8f0; font-size:0.9rem; outline:none; box-sizing:border-box; }
    input:focus { border-color:var(--brand); }
    input.invalid { border-color: var(--error); background: #fff1f2; }
    .readonly { background:#f1f5f9; color:#64748b; cursor: not-allowed; border-style: none; }
    
    /* Bodegas */
    .bodega-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px; }
    .btn-bodega { background:#f1f5f9; border:2px solid transparent; padding:10px 2px; border-radius:10px; font-size:.65rem; font-weight:600; cursor:pointer; }
    .btn-bodega.selected { border-color:var(--brand); color:var(--brand); background: #fff; }

    /* Sugerencias */
    .suggestions { position:absolute; width:100%; background:#fff; border-radius:10px; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); z-index:100; display:none; margin-top:2px; border:1px solid #e2e8f0; max-height:200px; overflow-y:auto; }
    .suggestion-item { padding:12px; border-bottom:1px solid #f1f5f9; font-size:.85rem; cursor:pointer; }
    .suggestion-item:hover { background: #f8fafc; color: var(--brand); }

    .btn-send { width:100%; padding:16px; border-radius:12px; background:var(--brand); color:white; border:none; font-weight:600; margin-top:20px; cursor:pointer; }
    #previewFoto { margin-top:15px; width:100%; border-radius:12px; display:none; border:1px solid #e2e8f0; }
    .hidden { display:none; }
</style>
</head>
<body>

<header>
    <h1 id="reloj">00:00:00</h1>
    <p style="font-size: .8rem; color: #64748b; margin:0;">Registro de Repuestos 2026</p>
</header>

<div class="container">
    <div class="card" id="consentimiento" style="text-align:center;">
        <h2 style="font-size:1rem;">Sincronizando Datos...</h2>
        <button onclick="activar()" id="btnStart" disabled class="btn-send" style="background:#cbd5e1;">Cargando Inventario...</button>
    </div>

    <form id="mainForm" class="hidden">
        <div class="card">
            <div style="position:relative">
                <label>üë§ T√©cnico (Seleccionar de lista)</label>
                <input type="text" id="tecnico" placeholder="Escriba para buscar..." required autocomplete="off">
                <div id="tecnicoSug" class="suggestions"></div>
            </div>

            <label>üìç Bodega</label>
            <div class="bodega-grid">
                <button type="button" class="btn-bodega" onclick="selectB(this,'SAN BENITO')">San Benito</button>
                <button type="button" class="btn-bodega" onclick="selectB(this,'BODEGA CENTRAL')">Central</button>
                <button type="button" class="btn-bodega" onclick="selectB(this,'TALNIQUE')">Talnique</button>
            </div>
            <input type="hidden" id="bodega" required>

            <div style="position:relative">
                <label>üì° Sitio de Instalaci√≥n</label>
                <input type="text" id="siteSearch" placeholder="Nombre del sitio..." autocomplete="off" required>
                <div id="siteSug" class="suggestions"></div>
            </div>
            <input type="text" id="idSitio" class="readonly" placeholder="ID autom√°tico" readonly required>

            <div style="position:relative">
                <label>üì¶ Repuesto / Equipo</label>
                <input type="text" id="eqSearch" placeholder="Descripci√≥n del equipo..." autocomplete="off" required>
                <div id="eqSug" class="suggestions"></div>
            </div>
            <input type="text" id="marca" class="readonly" placeholder="Marca autom√°tica" readonly required>

            <label>üî¢ N√∫mero de Serie</label>
            <input type="text" id="serie" placeholder="Ingrese S/N" required>

            <label>üì∑ Evidencia (Foto)</label>
            <input type="file" id="foto" accept="image/*" required>
            <img id="previewFoto">

            <button type="submit" id="btnEnviar" class="btn-send">FINALIZAR REGISTRO</button>
        </div>
    </form>
</div>

<script>
const CONFIG = {
    URL_SITIOS_CSV: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_5CZtD7qHGW5cWHGAjn7ALTphVm5h88lco9cySYoAe2VBW4fq8DQ7-SZY6cd_FHtNQJS3MpE88hs/pub?gid=1955381502&single=true&output=csv',
    URL_TECNICOS_CSV: 'tecnicos.csv',
    URL_APPS_SCRIPT: 'https://script.google.com/macros/s/AKfycbz_Wv6DikTWQuqnAd9gMrjfEoFOFa9E9YdUuY5cSkr4ICqBKOo5WPvmJrhYF5_dv5fa/exec',
    URL_FORMS_EXTERNO: 'https://docs.google.com/forms/d/e/1FAIpQLSdeek133oAtejD-fC1LPvFPDHiej3l0tokNW9N31LdHFpS06g/viewform'
};

let sites=[], equipos=[], tecnicos=[];
let validSelections = { tecnico: false, siteSearch: false, eqSearch: false };

setInterval(() => {
    document.getElementById('reloj').innerText = new Date().toLocaleTimeString("es-SV", {hour12:false});
}, 1000);

window.onload = () => {
    // Carga de T√©cnicos
    fetch(CONFIG.URL_TECNICOS_CSV).then(r => r.text()).then(t => {
        tecnicos = t.split(/\r?\n/).map(l => l.trim()).filter(l => l !== '').map(n => ({nombre: n}));
        setupStrictAutocomplete(document.getElementById('tecnico'), document.getElementById('tecnicoSug'), tecnicos, 'nombre', null, 'tecnico');
        checkReady();
    });

    // Carga de Sitios
    fetch(CONFIG.URL_SITIOS_CSV).then(r => r.text()).then(t => {
        sites = parseCSV(t);
        setupStrictAutocomplete(document.getElementById('siteSearch'), document.getElementById('siteSug'), sites, 'NOMBRE DE SITIO', 'idSitio', 'siteSearch', 'SITEID');
    });

    // Carga de Repuestos
    Papa.parse("inventario_repuestos.csv", {
        download: true, header: true, delimiter: ";", skipEmptyLines: true,
        complete: function(res) { 
            equipos = res.data; 
            setupStrictAutocomplete(document.getElementById('eqSearch'), document.getElementById('eqSug'), equipos, 'DESCRIPCION DE EQUIPO', 'marca', 'eqSearch', 'marca');
        }
    });
};

function parseCSV(d) {
    const r = d.split(/\r?\n/).filter(x => x.trim() !== '');
    const h = r[0].split(',').map(x => x.trim().replace(/"/g,''));
    return r.slice(1).map(row => {
        const v = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        let o = {}; h.forEach((k, i) => o[k] = v[i] ? v[i].trim().replace(/"/g,'') : ''); 
        return o;
    });
}

function checkReady() {
    const b = document.getElementById('btnStart');
    b.disabled = false; b.style.background = "#4f46e5"; b.innerText = "¬°EMPEZAR REGISTRO!";
}

// L√ìGICA DE AUTOCOMPLETADO ESTRICTO
function setupStrictAutocomplete(input, sugBox, items, key, linkedId, selectionKey, extraKey) {
    input.addEventListener('input', () => {
        const val = input.value.toLowerCase().trim();
        validSelections[selectionKey] = false; // Invalidamos hasta que elija
        input.classList.add('invalid');
        sugBox.innerHTML = '';
        if (!val) { sugBox.style.display = 'none'; return; }

        const matches = items.filter(i => i[key].toLowerCase().includes(val)).slice(0, 8);
        if (matches.length === 0) { sugBox.style.display = 'none'; return; }

        matches.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = item[key];
            div.onclick = () => {
                input.value = item[key];
                input.classList.remove('invalid');
                validSelections[selectionKey] = true;
                if (linkedId) {
                    document.getElementById(linkedId).value = item[extraKey] || '';
                }
                sugBox.style.display = 'none';
            };
            sugBox.appendChild(div);
        });
        sugBox.style.display = 'block';
    });

    // Validar al salir del campo (blur)
    input.addEventListener('blur', () => {
        setTimeout(() => {
            if (!validSelections[selectionKey]) {
                input.value = ''; // Borra lo escrito si no es v√°lido
                if (linkedId) document.getElementById(linkedId).value = '';
                input.classList.remove('invalid');
                sugBox.style.display = 'none';
            }
        }, 200);
    });
}

function selectB(btn, v) {
    document.querySelectorAll('.btn-bodega').forEach(x => x.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById('bodega').value = v;
}

function activar() {
    document.getElementById('consentimiento').classList.add('hidden');
    document.getElementById('mainForm').classList.remove('hidden');
}

// FOTO CON MARCA DE AGUA
const fotoInput = document.getElementById("foto");
fotoInput.addEventListener("change", () => {
    if (fotoInput.files && fotoInput.files[0]) {
        if (!validSelections.tecnico || !validSelections.siteSearch) {
            alert("‚ö†Ô∏è Selecciona un T√©cnico y un Sitio v√°lidos antes de la foto.");
            fotoInput.value = ""; return;
        }
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                const max = 1000;
                let w = img.width, h = img.height;
                if (w > h && w > max) { h *= max / w; w = max; }
                else if (h >= w && h > max) { w *= max / h; h = max; }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                
                const txt = `${new Date().toLocaleString()} | ${document.getElementById('tecnico').value} | ${document.getElementById('siteSearch').value}`;
                ctx.fillStyle = "rgba(0,0,0,0.6)";
                ctx.fillRect(0, h-40, w, 40);
                ctx.fillStyle = "white";
                ctx.font = "16px Arial";
                ctx.fillText(txt, 15, h-15);
                
                const data = canvas.toDataURL("image/jpeg", 0.7);
                document.getElementById('previewFoto').src = data;
                document.getElementById('previewFoto').style.display = "block";
                fotoInput.dataset.compressed = data.split(',')[1];
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(fotoInput.files[0]);
    }
});

document.getElementById('mainForm').onsubmit = async e => {
    e.preventDefault();
    if (!validSelections.tecnico || !validSelections.siteSearch || !validSelections.eqSearch) {
        alert("‚ö†Ô∏è Por favor, aseg√∫rese de seleccionar los elementos de las listas desplegables.");
        return;
    }
    // ... l√≥gica de env√≠o (se mantiene igual a tu c√≥digo original)
    const b = document.getElementById('btnEnviar');
    b.disabled = true; b.innerText = "Registrando...";
    // ... resto del fetch ...
    alert("¬°Datos validados y listos para enviar!");
    // (AQU√ç IR√çA TU FETCH POST QUE YA TIENES)
};
</script>
</body>
</html>

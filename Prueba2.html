<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Repuestos Go! - Registro de Trazabilidad</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<style>
    :root { --brand: #4f46e5; --brand-light: #818cf8; --bg: #f8fafc; --card-bg: #ffffff; --text: #1e293b; }
    body { font-family: 'Poppins', sans-serif; background: radial-gradient(circle at top left, #eef2ff 0%, #f8fafc 100%); color: var(--text); margin:0; padding:0; min-height:100vh; }
    header { padding:20px; text-align:center; background: var(--card-bg); border-bottom-left-radius:30px; border-bottom-right-radius:30px; box-shadow:0 4px 20px rgba(0,0,0,0.05); }
    header h1 { margin:0; font-size:1.3rem; color: var(--brand); }
    .timer-pill { background: var(--brand); color:white; padding:5px 15px; border-radius:20px; font-size:.7rem; font-weight:600; display:inline-block; margin-bottom:10px; }
    .container { width:92%; max-width:450px; margin:15px auto; }
    .card { background: var(--card-bg); border-radius:24px; padding:20px; box-shadow:0 10px 25px rgba(0,0,0,0.03); border:1px solid rgba(255,255,255,0.8); margin-bottom:15px; }
    label { display:block; margin-top:12px; font-size:.75rem; font-weight:600; color:#64748b; margin-left:5px; }
    input { width:100%; padding:12px; margin-top:5px; border-radius:12px; border:1.5px solid #e2e8f0; background:#f8fafc; font-size:0.95rem; outline:none; box-sizing:border-box; transition: .3s; }
    input:focus { border-color:var(--brand-light); background:#fff; box-shadow:0 0 0 4px rgba(79,70,229,.1); }
    .readonly { background:#f1f5f9; color:#64748b; border-style:dashed; }
    .bodega-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:8px; }
    .btn-bodega { background:#f1f5f9; border:2px solid transparent; padding:10px 5px; border-radius:12px; font-size:.7rem; font-weight:600; color:#475569; cursor:pointer; }
    .btn-bodega.selected { background:#fff; border-color:var(--brand); color:var(--brand); box-shadow:0 5px 10px rgba(79,70,229,0.1); }
    .suggestions { position:absolute; width:100%; background:#fff; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.1); z-index:100; display:none; margin-top:5px; border:1px solid #e2e8f0; max-height:180px; overflow-y:auto; }
    .suggestion-item { padding:12px 15px; border-bottom:1px solid #f1f5f9; font-size:.85rem; cursor:pointer; }
    .suggestion-item:active { background:#f1f5f9; }
    .btn-send { width:100%; padding:15px; border-radius:15px; background:linear-gradient(135deg,var(--brand),var(--brand-light)); color:white; border:none; font-weight:600; font-size:1rem; margin-top:20px; cursor:pointer; }
    .btn-send:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
    .hidden { display:none; }
    #previewFoto { margin-top:15px; width:100%; border-radius:12px; display:none; border:2px solid #e2e8f0; }
</style>
</head>
<body>

<header>
    <div class="timer-pill" id="reloj">00:00:00</div>
    <h1>Registro de Salida</h1>
</header>

<div class="container">
    <div class="card" id="consentimiento" style="text-align:center;">
        <div style="font-size:3rem; margin-bottom:10px;">üì¶</div>
        <h2 style="font-size:1.1rem;">Panel de Control</h2>
        <p style="color:#64748b; font-size:.85rem;">Sincronizando inventario y t√©cnicos para el sitio.</p>
        <button onclick="activar()" id="btnStart" disabled class="btn-send">Cargando...</button>
        <div id="load-info" style="font-size: .7rem; margin-top:10px; color:#94a3b8;">Espere un momento...</div>
    </div>

    <form id="mainForm" class="hidden">
        <div class="card">
            <div style="position:relative">
                <label>Nombre del T√©cnico</label>
                <input type="text" id="tecnico" placeholder="Buscar t√©cnico..." required autocomplete="off">
                <div id="tecnicoSug" class="suggestions"></div>
            </div>

            <label>Bodega de Retiro</label>
            <div class="bodega-grid">
                <button type="button" class="btn-bodega" onclick="selectB(this,'SAN BENITO')">San Benito</button>
                <button type="button" class="btn-bodega" onclick="selectB(this,'BODEGA CENTRAL')">Central</button>
                <button type="button" class="btn-bodega" onclick="selectB(this,'TALNIQUE')">Talnique</button>
            </div>
            <input type="hidden" id="bodega" required>

            <div style="position:relative">
                <label>Sitio de Instalaci√≥n</label>
                <input type="text" id="siteSearch" placeholder="Escribe nombre de sitio..." autocomplete="off" required>
                <div id="siteSug" class="suggestions"></div>
            </div>
            <input type="text" id="idSitio" class="readonly" placeholder="ID Sitio" readonly required>

            <div style="position:relative">
                <label>Repuesto / Equipo</label>
                <input type="text" id="eqSearch" placeholder="¬øQu√© equipo llevas?" autocomplete="off" required>
                <div id="eqSug" class="suggestions"></div>
            </div>
            <input type="text" id="marca" class="readonly" placeholder="Marca detectada" readonly required>

            <label>N√∫mero de Serie</label>
            <input type="text" id="serie" placeholder="Ingrese S/N" required>

            <label>Evidencia Fotogr√°fica (C√°mara o Galer√≠a)</label>
            <input type="file" id="foto" accept="image/*" required>
            <img id="previewFoto">

            <button type="submit" id="btnEnviar" class="btn-send">FINALIZAR REGISTRO</button>
        </div>
    </form>
</div>

<script>
const CONFIG = {
    URL_SITIOS_CSV: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_5CZtD7qHGW5cWHGAjn7ALTphVm5h88lco9cySYoAe2VBW4fq8DQ7-SZY6cd_FHtNQJS3MpE88hs/pub?gid=1955381502&single=true&output=csv',
    URL_TECNICOS_CSV: 'tecnicos.csv', 
    URL_APPS_SCRIPT: 'https://script.google.com/macros/s/AKfycbz_Wv6DikTWQuqnAd9gMrjfEoFOFa9E9YdUuY5cSkr4ICqBKOo5WPvmJrhYF5_dv5fa/exec',
    URL_FORMS_EXTERNO: 'https://docs.google.com/forms/d/e/1FAIpQLSdeek133oAtejD-fC1LPvFPDHiej3l0tokNW9N31LdHFpS06g/viewform'
};

let sites=[], equipos=[], tecnicos=[];

// Reloj en tiempo real
setInterval(() => {
    document.getElementById('reloj').innerText = new Date().toLocaleTimeString("es-SV", {timeZone:"America/El_Salvador", hour12:false});
}, 1000);

window.onload = () => {
    // Carga de T√©cnicos desde CSV (NOMBRE APELLIDO)
    fetch(CONFIG.URL_TECNICOS_CSV)
        .then(r => r.text())
        .then(t => {
            tecnicos = t.split(/\r?\n/).map(l => l.trim()).filter(l => l !== '').map(n => ({nombre: n}));
            setupAutocomplete(document.getElementById('tecnico'), document.getElementById('tecnicoSug'), tecnicos, 'nombre');
            verificarCarga();
        });

    // Carga de Sitios
    fetch(CONFIG.URL_SITIOS_CSV).then(r => r.text()).then(t => {
        sites = parseCSV(t);
        setupAutocomplete(document.getElementById('siteSearch'), document.getElementById('siteSug'), sites, 'NOMBRE DE SITIO', 'SITEID');
    });

    // Carga de Repuestos
    Papa.parse("inventario_repuestos.csv", {
        download: true, header: true, delimiter: ";", skipEmptyLines: true,
        complete: function(res) { 
            equipos = res.data; 
            setupAutocomplete(document.getElementById('eqSearch'), document.getElementById('eqSug'), equipos, 'DESCRIPCION DE EQUIPO', 'marca');
        }
    });
};

function verificarCarga() {
    const btn = document.getElementById('btnStart');
    btn.disabled = false;
    btn.innerText = "¬°EMPEZAR!";
    document.getElementById('load-info').innerText = "Sistema listo para registro.";
}

function parseCSV(d) {
    const r = d.split(/\r?\n/).filter(x => x.trim() !== '');
    const h = r[0].split(',').map(x => x.trim().replace(/"/g,''));
    return r.slice(1).map(row => {
        const v = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        let o = {}; h.forEach((k, i) => o[k] = v[i] ? v[i].trim().replace(/"/g,'') : ''); 
        return o;
    });
}

function selectB(btn, v) {
    document.querySelectorAll('.btn-bodega').forEach(x => x.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById('bodega').value = v;
}

function activar() {
    document.getElementById('consentimiento').classList.add('hidden');
    document.getElementById('mainForm').classList.remove('hidden');
}

function setupAutocomplete(input, sugBox, items, key, linkedId) {
    input.addEventListener('input', () => {
        const val = input.value.toLowerCase().trim();
        sugBox.innerHTML = '';
        if (!val) { sugBox.style.display = 'none'; return; }

        const matches = items.filter(i => i[key].toLowerCase().includes(val)).slice(0, 10);
        if (matches.length === 0) { sugBox.style.display = 'none'; return; }

        matches.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = item[key];
            div.onclick = () => {
                input.value = item[key];
                if (linkedId) document.getElementById(linkedId).value = item[linkedId] || item['SITEID'] || item['marca'] || '';
                sugBox.style.display = 'none';
            };
            sugBox.appendChild(div);
        });
        sugBox.style.display = 'block';
    });
}

// MARCA DE AGUA DIN√ÅMICA
const fotoInput = document.getElementById("foto");
const preview = document.getElementById("previewFoto");

fotoInput.addEventListener("change", () => {
    if (fotoInput.files && fotoInput.files[0]) {
        const valTecnico = document.getElementById('tecnico').value;
        const valSitio = document.getElementById('siteSearch').value;

        if (!valTecnico || !valSitio) {
            alert("‚ö†Ô∏è Selecciona T√©cnico y Sitio antes de la foto.");
            fotoInput.value = ""; return;
        }

        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement("canvas");
                const maxSide = 1200;
                let w = img.width, h = img.height;
                if (w > h && w > maxSide) { h *= maxSide / w; w = maxSide; }
                else if (h >= w && h > maxSide) { w *= maxSide / h; h = maxSide; }

                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, w, h);

                const fecha = new Date().toLocaleString("es-SV", { timeZone: "America/El_Salvador" });
                const texto = `${fecha} | ${valTecnico.toUpperCase()} | SITIO: ${valSitio.toUpperCase()}`;

                ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
                ctx.fillRect(0, h - 50, w, 50);
                ctx.fillStyle = "white";
                ctx.font = "bold 20px Poppins, Arial";
                ctx.fillText(texto, 20, h - 22);

                const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
                preview.src = dataUrl;
                preview.style.display = "block";
                fotoInput.dataset.compressed = dataUrl.split(',')[1];
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(fotoInput.files[0]);
    }
});

document.getElementById('mainForm').onsubmit = async e => {
    e.preventDefault();
    const b = document.getElementById('btnEnviar');
    const params = {
        tecnico: document.getElementById('tecnico').value,
        bodega: document.getElementById('bodega').value,
        idSitio: document.getElementById('idSitio').value,
        nombreSitio: document.getElementById('siteSearch').value,
        descripcion: document.getElementById('eqSearch').value,
        marca: document.getElementById('marca').value,
        serie: document.getElementById('serie').value,
        fileData: fotoInput.dataset.compressed,
        fileName: `REP_${document.getElementById('idSitio').value}_${Date.now()}.jpg`,
        mimeType: "image/jpeg"
    };

    if(!params.bodega || !params.fileData) { alert("Completa bodega y foto"); return; }

    b.disabled = true; b.innerText = "Sincronizando...";
    try {
        const r = await fetch(CONFIG.URL_APPS_SCRIPT, {method:"POST", body:new URLSearchParams(params)});
        const res = await r.json();
        if(res.result === "success") {
            const finalUrl = `${CONFIG.URL_FORMS_EXTERNO}?entry.1637897291=CELECT`+
                `&entry.795516044=${encodeURIComponent(params.bodega)}`+
                `&entry.1265319450=${encodeURIComponent(params.idSitio)}`+
                `&entry.1509520939=${encodeURIComponent(params.nombreSitio)}`+
                `&entry.554570123=${encodeURIComponent(params.marca)}`+
                `&entry.1914147166=${encodeURIComponent(params.descripcion)}`+
                `&entry.1497572830=${encodeURIComponent(params.serie)}`+
                `&entry.733439703=${encodeURIComponent(res.fileUrl)}`;
            window.location.href = finalUrl;
        }
    } catch(x) { alert("Error de red"); b.disabled = false; b.innerText = "REINTENTAR"; }
};
</script>
</body>
</html>

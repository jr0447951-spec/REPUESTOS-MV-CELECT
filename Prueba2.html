<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Repuestos Go! - Network Ops 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --brand: #4f46e5; --brand-light: #818cf8; --bg: #f8fafc; --card-bg: #ffffff; --text: #1e293b; --error: #ef4444; }
        body { font-family: 'Poppins', sans-serif; background: radial-gradient(circle at top left, #eef2ff 0%, #f8fafc 100%); color: var(--text); margin: 0; min-height: 100vh; }
        header { padding: 25px 20px; text-align: center; background: var(--card-bg); border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        header h1 { margin: 0; font-size: 1.4rem; color: var(--brand); font-weight: 600; }
        .container { width: 90%; max-width: 450px; margin: 20px auto; }
        .card { background: var(--card-bg); border-radius: 24px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.8); margin-bottom: 20px; }
        label { display: block; margin-top: 15px; font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input { width: 100%; padding: 14px; margin-top: 6px; border-radius: 16px; border: 1.5px solid #e2e8f0; background: #f8fafc; font-size: 1rem; outline: none; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--brand-light); background: #fff; }
        input.invalid { border-color: var(--error); background: #fff1f2; }
        .readonly { background: #f1f5f9; color: #94a3b8; border-style: none; cursor: not-allowed; }
        
        .suggestions { position: absolute; width: 100%; background: #fff; border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); z-index: 100; display: none; margin-top: 5px; border: 1px solid #e2e8f0; max-height: 180px; overflow-y: auto; }
        .suggestion-item { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; cursor: pointer; line-height: 1.4; }
        .suggestion-item strong { color: var(--brand); }

        .photo-box { border: 2px dashed #cbd5e1; border-radius: 18px; padding: 25px; text-align: center; background: #f8fafc; cursor: pointer; margin-top: 10px; }
        #previewFoto { width: 100%; border-radius: 14px; display: none; margin-top: 10px; border: 1px solid #e2e8f0; }
        
        .bodega-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 8px; }
        .btn-bodega { background: #f1f5f9; border: 2px solid transparent; padding: 12px 5px; border-radius: 14px; font-size: 0.65rem; font-weight: 600; color: #475569; cursor: pointer; }
        .btn-bodega.selected { background: #fff; border-color: var(--brand); color: var(--brand); box-shadow: 0 5px 15px rgba(79, 70, 229, 0.1); }

        .btn-send { width: 100%; padding: 18px; border-radius: 18px; background: linear-gradient(135deg, var(--brand), var(--brand-light)); color: white; border: none; font-weight: 600; font-size: 1rem; margin-top: 30px; cursor: pointer; }
        .btn-send:disabled { background: #cbd5e1; cursor: not-allowed; }
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div id="reloj" style="font-weight: 600; color: var(--brand); margin-bottom: 5px;">00:00:00</div>
    <h1>Registro de Salida</h1>
</header>

<div class="container">
    <div class="card" id="consentimiento" style="text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 10px;">üì¶</div>
        <h2>Sincronizando Sistema</h2>
        <p id="status-text" style="color: #64748b; font-size: 0.9rem;">Cargando base de repuestos...</p>
        <button onclick="activarForm()" id="btnStart" disabled class="btn-send" style="background: #94a3b8;">Cargando...</button>
    </div>

    <form id="mainForm" class="hidden">
        <div class="card">
            <div style="position:relative">
                <label>üë§ T√©cnico Responsable</label>
                <input type="text" id="tecnico" placeholder="Escribe tu nombre..." autocomplete="off" required>
                <div id="tecSug" class="suggestions"></div>
            </div>

            <label>üìç Bodega de Retiro</label>
            <div class="bodega-grid">
                <button type="button" class="btn-bodega" onclick="setBodega(this, 'SAN BENITO')">San Benito</button>
                <button type="button" class="btn-bodega" onclick="setBodega(this, 'BODEGA CENTRAL')">Central</button>
                <button type="button" class="btn-bodega" onclick="setBodega(this, 'TALNIQUE')">Talnique</button>
            </div>
            <input type="hidden" id="bodega" required>

            <div style="position:relative">
                <label>üì° Sitio de Destino</label>
                <input type="text" id="siteSearch" placeholder="Nombre del sitio..." autocomplete="off" required>
                <div id="siteSug" class="suggestions"></div>
            </div>
            <input type="text" id="idSitio" class="readonly" placeholder="ID Sitio" readonly required>

            <div style="position:relative">
                <label>üì¶ Repuesto / Equipo</label>
                <input type="text" id="eqSearch" placeholder="Escribe descripci√≥n..." autocomplete="off" required>
                <div id="eqSug" class="suggestions"></div>
            </div>
            <input type="text" id="marca" class="readonly" placeholder="Marca detectada" readonly required>

            <label>üî¢ N√∫mero de Serie</label>
            <input type="text" id="serie" placeholder="S/N de la pieza" required>

            <label>üì∑ Evidencia Fotogr√°fica</label>
            <div class="photo-box" onclick="document.getElementById('foto').click()">
                <div id="instrucciones-foto">
                    <div style="font-size: 2rem;">üì∑</div>
                    <p style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">Toca para capturar o adjuntar</p>
                    <small style="color: #94a3b8;">(Se aplicar√° marca de agua y compresi√≥n HD)</small>
                </div>
                <img id="previewFoto">
            </div>
            <input type="file" id="foto" accept="image/*" class="hidden" required>

            <button type="submit" id="btnEnviar" class="btn-send">FINALIZAR REGISTRO</button>
        </div>
    </form>
</div>

<script>
    const CONFIG = {
        URL_SITIOS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_5CZtD7qHGW5cWHGAjn7ALTphVm5h88lco9cySYoAe2VBW4fq8DQ7-SZY6cd_FHtNQJS3MpE88hs/pub?gid=1955381502&single=true&output=csv',
        URL_TECNICOS: 'tecnicos.csv',
        URL_REPUESTOS: 'inventario_repuestos.csv',
        URL_SCRIPT: 'https://script.google.com/macros/s/AKfycbz_Wv6DikTWQuqnAd9gMrjfEoFOFa9E9YdUuY5cSkr4ICqBKOo5WPvmJrhYF5_dv5fa/exec',
        URL_FORM: 'https://docs.google.com/forms/d/e/1FAIpQLSdeek133oAtejD-fC1LPvFPDHiej3l0tokNW9N31LdHFpS06g/viewform'
    };

    let data_tecnicos = [], data_sitios = [], data_equipos = [];
    let validacion = { tecnico: false, sitio: false, equipo: false };

    setInterval(() => { document.getElementById('reloj').innerText = new Date().toLocaleTimeString("es-SV", {hour12:false}); }, 1000);

    window.onload = async () => {
        // 1. Cargar T√©cnicos
        try {
            const resT = await fetch(CONFIG.URL_TECNICOS);
            const txtT = await resT.text();
            data_tecnicos = txtT.split(/\r?\n/).filter(l => l.trim()).map(n => ({nombre: n.trim()}));
            setupStrict(document.getElementById('tecnico'), document.getElementById('tecSug'), data_tecnicos, 'nombre', null, 'tecnico');
        } catch(e) { console.error("Error t√©cnicos"); }

        // 2. Cargar Sitios
        try {
            const resS = await fetch(CONFIG.URL_SITIOS);
            const txtS = await resS.text();
            data_sitios = parseCSV(txtS);
            setupStrict(document.getElementById('siteSearch'), document.getElementById('siteSug'), data_sitios, 'NOMBRE DE SITIO', 'idSitio', 'sitio', 'SITEID');
        } catch(e) { console.error("Error sitios"); }

        // 3. Cargar Repuestos (Con detecci√≥n de errores)
        Papa.parse(CONFIG.URL_REPUESTOS, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: (res) => {
                data_equipos = res.data;
                console.log("Datos equipos:", data_equipos[0]); // Debug
                
                // Mapeo flexible por si las columnas cambian ligeramente
                setupStrict(
                    document.getElementById('eqSearch'), 
                    document.getElementById('eqSug'), 
                    data_equipos, 
                    'DESCRIPCION DE EQUIPO', 
                    'marca', 
                    'equipo', 
                    'MARCA'
                );
                
                checkReady();
            },
            error: () => { document.getElementById('status-text').innerText = "‚ö†Ô∏è Error cargando inventario_repuestos.csv"; }
        });
    };

    function parseCSV(d) {
        const rows = d.split(/\r?\n/).filter(x => x.trim());
        const headers = rows[0].split(',').map(x => x.trim().replace(/"/g,''));
        return rows.slice(1).map(row => {
            const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            let obj = {}; headers.forEach((h, i) => obj[h] = values[i] ? values[i].trim().replace(/"/g,'') : '');
            return obj;
        });
    }

    function setupStrict(input, box, items, key, linkedId, valKey, extraKey) {
        input.addEventListener('input', () => {
            validacion[valKey] = false;
            input.classList.add('invalid');
            const v = input.value.toLowerCase().trim();
            box.innerHTML = '';
            
            if (v.length < 1) { box.style.display = 'none'; return; }

            const matches = items.filter(i => {
                const text = (i[key] || "").toString().toLowerCase();
                return text.includes(v);
            }).slice(0, 8);

            matches.forEach(item => {
                const d = document.createElement('div');
                d.className = 'suggestion-item';
                d.innerHTML = `<strong>${item[key]}</strong>${item[extraKey] ? '<br><small>'+item[extraKey]+'</small>' : ''}`;
                d.onclick = () => {
                    input.value = item[key];
                    if (linkedId) document.getElementById(linkedId).value = item[extraKey] || '';
                    validacion[valKey] = true;
                    input.classList.remove('invalid');
                    box.style.display = 'none';
                };
                box.appendChild(d);
            });
            box.style.display = matches.length ? 'block' : 'none';
        });

        input.addEventListener('blur', () => {
            setTimeout(() => {
                if (!validacion[valKey]) {
                    input.value = '';
                    if (linkedId) document.getElementById(linkedId).value = '';
                    input.classList.remove('invalid');
                }
                box.style.display = 'none';
            }, 300);
        });
    }

    function checkReady() {
        if(data_equipos.length > 0) {
            const b = document.getElementById('btnStart');
            b.disabled = false;
            b.style.background = "var(--brand)";
            b.innerText = "¬°EMPEZAR REGISTRO!";
            document.getElementById('status-text').innerText = "Sistemas Sincronizados";
        }
    }

    function setBodega(btn, v) {
        document.querySelectorAll('.btn-bodega').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('bodega').value = v;
    }

    function activarForm() {
        document.getElementById('consentimiento').classList.add('hidden');
        document.getElementById('mainForm').classList.remove('hidden');
    }

    // --- PROCESAMIENTO HD + MARCA DE AGUA ---
    const fotoIn = document.getElementById('foto');
    fotoIn.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            if (!validacion.tecnico || !validacion.sitio) {
                alert("‚ö†Ô∏è Selecciona T√©cnico y Sitio antes de la foto.");
                this.value = ''; return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Configuraci√≥n HD Recomendada (1600px)
                    const MAX = 1600;
                    let w = img.width, h = img.height;
                    if (w > h && w > MAX) { h *= MAX / w; w = MAX; }
                    else if (h >= w && h > MAX) { w *= MAX / h; h = MAX; }
                    
                    canvas.width = w; canvas.height = h;
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, w, h);

                    // Marca de Agua Profesional
                    const txt = `${new Date().toLocaleString()} | T√©c: ${document.getElementById('tecnico').value} | Sitio: ${document.getElementById('idSitio').value}`;
                    ctx.fillStyle = "rgba(0,0,0,0.6)";
                    ctx.fillRect(0, h - 70, w, 70);
                    ctx.fillStyle = "white";
                    ctx.font = "bold 24px Poppins, Arial";
                    ctx.fillText(txt, 30, h - 30);

                    // Compresi√≥n Calidad 0.8
                    const data = canvas.toDataURL("image/jpeg", 0.8);
                    document.getElementById('previewFoto').src = data;
                    document.getElementById('previewFoto').style.display = 'block';
                    document.getElementById('instrucciones-foto').style.display = 'none';
                    fotoIn.dataset.blob = data.split(',')[1];
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    document.getElementById('mainForm').onsubmit = async (e) => {
        e.preventDefault();
        if(!validacion.tecnico || !validacion.sitio || !validacion.equipo) {
            alert("‚ö†Ô∏è Por favor selecciona elementos v√°lidos de las listas."); return;
        }

        const b = document.getElementById('btnEnviar');
        const p = {
            tecnico: document.getElementById('tecnico').value,
            bodega: document.getElementById('bodega').value,
            idSitio: document.getElementById('idSitio').value,
            nombreSitio: document.getElementById('siteSearch').value,
            descripcion: document.getElementById('eqSearch').value,
            marca: document.getElementById('marca').value,
            serie: document.getElementById('serie').value,
            fileData: fotoIn.dataset.blob,
            fileName: `REP_${document.getElementById('idSitio').value}_${Date.now()}.jpg`,
            mimeType: "image/jpeg"
        };

        if(!p.bodega || !p.fileData) { alert("‚ö†Ô∏è Falta bodega o fotograf√≠a."); return; }
        b.disabled = true; b.innerText = "Registrando...";

        try {
            const res = await fetch(CONFIG.URL_SCRIPT, { method: 'POST', body: new URLSearchParams(p) });
            const json = await res.json();
            if(json.result === "success") {
                window.location.href = `${CONFIG.URL_FORM}?entry.1637897291=CELECT&entry.795516044=${encodeURIComponent(p.bodega)}&entry.1265319450=${p.idSitio}&entry.1509520939=${encodeURIComponent(p.nombreSitio)}&entry.554570123=${encodeURIComponent(p.marca)}&entry.1914147166=${encodeURIComponent(p.descripcion)}&entry.1497572830=${encodeURIComponent(p.serie)}&entry.733439703=${encodeURIComponent(json.fileUrl)}`;
            }
        } catch (err) { alert("Error de conexi√≥n"); b.disabled = false; b.innerText = "REINTENTAR"; }
    };
</script>
</body>
</html>

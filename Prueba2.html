<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Repuestos Go! - Pro v2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --brand: #4f46e5; --brand-light: #818cf8; --bg: #f8fafc; --card-bg: #ffffff; --text: #1e293b; --error: #ef4444; }
        body { font-family: 'Poppins', sans-serif; background: radial-gradient(circle at top left, #eef2ff 0%, #f8fafc 100%); color: var(--text); margin: 0; min-height: 100vh; }
        header { padding: 25px 20px; text-align: center; background: var(--card-bg); border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        header h1 { margin: 0; font-size: 1.4rem; color: var(--brand); font-weight: 600; }
        .container { width: 90%; max-width: 450px; margin: 20px auto; }
        .card { background: var(--card-bg); border-radius: 24px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.8); margin-bottom: 20px; }
        label { display: block; margin-top: 15px; font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Inputs y Autocompletado */
        input { width: 100%; padding: 14px; margin-top: 6px; border-radius: 16px; border: 1.5px solid #e2e8f0; background: #f8fafc; font-size: 1rem; outline: none; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--brand-light); background: #fff; }
        input.invalid { border-color: var(--error); background: #fff1f2; }
        .readonly { background: #f1f5f9; color: #94a3b8; border-style: none; cursor: not-allowed; }
        
        .suggestions { position: absolute; width: 100%; background: #fff; border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); z-index: 100; display: none; margin-top: 5px; border: 1px solid #e2e8f0; max-height: 180px; overflow-y: auto; }
        .suggestion-item { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; cursor: pointer; }
        
        /* Zona de Foto */
        .photo-box { border: 2px dashed #cbd5e1; border-radius: 18px; padding: 30px 20px; text-align: center; background: #f8fafc; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .photo-box:active { background: #f1f5f9; transform: scale(0.98); }
        #previewFoto { width: 100%; border-radius: 14px; display: none; margin-top: 10px; border: 1px solid #e2e8f0; }
        
        /* Bodegas */
        .bodega-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 8px; }
        .btn-bodega { background: #f1f5f9; border: 2px solid transparent; padding: 12px 5px; border-radius: 14px; font-size: 0.65rem; font-weight: 600; color: #475569; cursor: pointer; }
        .btn-bodega.selected { background: #fff; border-color: var(--brand); color: var(--brand); box-shadow: 0 5px 15px rgba(79, 70, 229, 0.1); }

        .btn-send { width: 100%; padding: 18px; border-radius: 18px; background: linear-gradient(135deg, var(--brand), var(--brand-light)); color: white; border: none; font-weight: 600; font-size: 1rem; margin-top: 30px; cursor: pointer; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2); }
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div id="reloj" style="font-weight: 600; color: var(--brand); margin-bottom: 5px;">00:00:00</div>
    <h1>Registro de Salida</h1>
</header>

<div class="container">
    <div class="card" id="consentimiento" style="text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 10px;">üõ°Ô∏è</div>
        <h2>Sistema de Trazabilidad</h2>
        <p style="color: #64748b; font-size: 0.9rem;">Cargando bases de datos de t√©cnicos y sitios...</p>
        <button onclick="activarForm()" id="btnStart" disabled class="btn-send" style="background: #94a3b8;">Sincronizando...</button>
    </div>

    <form id="mainForm" class="hidden">
        <div class="card">
            <div style="position:relative">
                <label>üë§ T√©cnico Responsable</label>
                <input type="text" id="tecnico" placeholder="Tu nombre..." autocomplete="off" required>
                <div id="tecSug" class="suggestions"></div>
            </div>

            <label>üìç Bodega de Retiro</label>
            <div class="bodega-grid">
                <button type="button" class="btn-bodega" onclick="setBodega(this, 'SAN BENITO')">San Benito</button>
                <button type="button" class="btn-bodega" onclick="setBodega(this, 'BODEGA CENTRAL')">Central</button>
                <button type="button" class="btn-bodega" onclick="setBodega(this, 'TALNIQUE')">Talnique</button>
            </div>
            <input type="hidden" id="bodega" required>

            <div style="position:relative">
                <label>üì° Sitio de Destino</label>
                <input type="text" id="siteSearch" placeholder="Nombre del sitio..." autocomplete="off" required>
                <div id="siteSug" class="suggestions"></div>
            </div>
            <input type="text" id="idSitio" class="readonly" placeholder="ID Sitio" readonly required>

            <div style="position:relative">
                <label>üì¶ Repuesto / Equipo</label>
                <input type="text" id="eqSearch" placeholder="Buscar repuesto..." autocomplete="off" required>
                <div id="eqSug" class="suggestions"></div>
            </div>
            <input type="text" id="marca" class="readonly" placeholder="Marca" readonly required>

            <label>üî¢ N√∫mero de Serie</label>
            <input type="text" id="serie" placeholder="Ingrese S/N" required>

            <label>üì∑ Evidencia (C√°mara o Galer√≠a)</label>
            <div class="photo-box" onclick="document.getElementById('foto').click()">
                <div id="instrucciones-foto">
                    <div style="font-size: 2rem;">üì∏</div>
                    <p style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">Capturar o adjuntar evidencia</p>
                </div>
                <img id="previewFoto">
            </div>
            <input type="file" id="foto" accept="image/*" class="hidden" required>

            <button type="submit" id="btnEnviar" class="btn-send">FINALIZAR Y ENVIAR</button>
        </div>
    </form>
</div>

<script>
    const CONFIG = {
        URL_SITIOS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_5CZtD7qHGW5cWHGAjn7ALTphVm5h88lco9cySYoAe2VBW4fq8DQ7-SZY6cd_FHtNQJS3MpE88hs/pub?gid=1955381502&single=true&output=csv',
        URL_TECNICOS: 'tecnicos.csv',
        URL_SCRIPT: 'https://script.google.com/macros/s/AKfycbz_Wv6DikTWQuqnAd9gMrjfEoFOFa9E9YdUuY5cSkr4ICqBKOo5WPvmJrhYF5_dv5fa/exec',
        URL_FORM: 'https://docs.google.com/forms/d/e/1FAIpQLSdeek133oAtejD-fC1LPvFPDHiej3l0tokNW9N31LdHFpS06g/viewform'
    };

    let data_tecnicos = [], data_sitios = [], data_equipos = [];
    let validacion = { tecnico: false, sitio: false, equipo: false };

    // Reloj
    setInterval(() => { document.getElementById('reloj').innerText = new Date().toLocaleTimeString("es-SV", {hour12:false}); }, 1000);

    window.onload = async () => {
        try {
            // Cargar T√©cnicos
            const resTec = await fetch(CONFIG.URL_TECNICOS);
            const txtTec = await resTec.text();
            data_tecnicos = txtTec.split(/\r?\n/).filter(l => l.trim()).map(n => ({nombre: n.trim()}));

            // Cargar Sitios
            const resSit = await fetch(CONFIG.URL_SITIOS);
            const txtSit = await resSit.text();
            data_sitios = parseCSV(txtSit);

            // Cargar Equipos
            Papa.parse("inventario_repuestos.csv", {
                download: true, header: true, delimiter: ";", skipEmptyLines: true,
                complete: (res) => {
                    data_equipos = res.data;
                    const b = document.getElementById('btnStart');
                    b.disabled = false; b.style.background = "var(--brand)"; b.innerText = "¬°EMPEZAR!";
                }
            });

            setupStrict(document.getElementById('tecnico'), document.getElementById('tecSug'), data_tecnicos, 'nombre', null, 'tecnico');
            setupStrict(document.getElementById('siteSearch'), document.getElementById('siteSug'), data_sitios, 'NOMBRE DE SITIO', 'idSitio', 'sitio', 'SITEID');
            setupStrict(document.getElementById('eqSearch'), document.getElementById('eqSug'), data_equipos, 'DESCRIPCION DE EQUIPO', 'marca', 'equipo', 'MARCA');

        } catch (e) { alert("Error cargando bases de datos"); }
    };

    function parseCSV(d) {
        const rows = d.split(/\r?\n/).filter(x => x.trim());
        const headers = rows[0].split(',').map(x => x.trim().replace(/"/g,''));
        return rows.slice(1).map(row => {
            const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            let obj = {}; headers.forEach((h, i) => obj[h] = values[i] ? values[i].trim().replace(/"/g,'') : '');
            return obj;
        });
    }

    function setupStrict(input, box, items, key, linkedId, valKey, extraKey) {
        input.addEventListener('input', () => {
            validacion[valKey] = false;
            input.classList.add('invalid');
            const v = input.value.toLowerCase().trim();
            box.innerHTML = '';
            if (!v) { box.style.display = 'none'; return; }
            const m = items.filter(i => i[key].toLowerCase().includes(v)).slice(0, 6);
            m.forEach(item => {
                const d = document.createElement('div');
                d.className = 'suggestion-item';
                d.innerHTML = `<strong>${item[key]}</strong>${item[extraKey] ? '<br><small>'+item[extraKey]+'</small>' : ''}`;
                d.onclick = () => {
                    input.value = item[key];
                    if (linkedId) document.getElementById(linkedId).value = item[extraKey] || '';
                    validacion[valKey] = true;
                    input.classList.remove('invalid');
                    box.style.display = 'none';
                };
                box.appendChild(d);
            });
            box.style.display = m.length ? 'block' : 'none';
        });
        input.addEventListener('blur', () => setTimeout(() => {
            if (!validacion[valKey]) { input.value = ''; if(linkedId) document.getElementById(linkedId).value = ''; input.classList.remove('invalid'); }
            box.style.display = 'none';
        }, 250));
    }

    function setBodega(btn, v) {
        document.querySelectorAll('.btn-bodega').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('bodega').value = v;
    }

    function activarForm() {
        document.getElementById('consentimiento').classList.add('hidden');
        document.getElementById('mainForm').classList.remove('hidden');
    }

    // --- PROCESAMIENTO RECOMENDADO DE IMAGEN ---
    const fotoIn = document.getElementById('foto');
    fotoIn.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            if (!validacion.tecnico || !validacion.sitio) {
                alert("Selecciona T√©cnico y Sitio antes de la foto");
                this.value = ''; return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // 1. Redimensionamiento a 1600px (Calidad recomendada)
                    const MAX = 1600;
                    let w = img.width, h = img.height;
                    if (w > h && w > MAX) { h *= MAX / w; w = MAX; }
                    else if (h >= w && h > MAX) { w *= MAX / h; h = MAX; }
                    
                    canvas.width = w; canvas.height = h;
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, w, h);

                    // 2. Marca de Agua
                    const txt = `${new Date().toLocaleString()} | ${document.getElementById('tecnico').value} | SITIO: ${document.getElementById('idSitio').value}`;
                    ctx.fillStyle = "rgba(0,0,0,0.6)";
                    ctx.fillRect(0, h - 60, w, 60);
                    ctx.fillStyle = "white";
                    ctx.font = "bold 22px Poppins, Arial";
                    ctx.fillText(txt, 25, h - 25);

                    // 3. Compresi√≥n a 0.8 (Punto dulce de calidad/peso)
                    const data = canvas.toDataURL("image/jpeg", 0.8);
                    document.getElementById('previewFoto').src = data;
                    document.getElementById('previewFoto').style.display = 'block';
                    document.getElementById('instrucciones-foto').style.display = 'none';
                    fotoIn.dataset.blob = data.split(',')[1];
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    document.getElementById('mainForm').onsubmit = async (e) => {
        e.preventDefault();
        const b = document.getElementById('btnEnviar');
        const params = {
            tecnico: document.getElementById('tecnico').value,
            bodega: document.getElementById('bodega').value,
            idSitio: document.getElementById('idSitio').value,
            nombreSitio: document.getElementById('siteSearch').value,
            descripcion: document.getElementById('eqSearch').value,
            marca: document.getElementById('marca').value,
            serie: document.getElementById('serie').value,
            fileData: fotoIn.dataset.blob,
            fileName: `REP_${document.getElementById('idSitio').value}_${Date.now()}.jpg`,
            mimeType: "image/jpeg"
        };

        if(!params.bodega || !params.fileData) { alert("Falta bodega o foto"); return; }
        b.disabled = true; b.innerText = "Registrando...";

        try {
            const res = await fetch(CONFIG.URL_SCRIPT, { method: 'POST', body: new URLSearchParams(params) });
            const json = await res.json();
            if(json.result === "success") {
                window.location.href = `${CONFIG.URL_FORM}?entry.1637897291=CELECT&entry.795516044=${encodeURIComponent(params.bodega)}&entry.1265319450=${params.idSitio}&entry.1509520939=${encodeURIComponent(params.nombreSitio)}&entry.554570123=${encodeURIComponent(params.marca)}&entry.1914147166=${encodeURIComponent(params.descripcion)}&entry.1497572830=${encodeURIComponent(params.serie)}&entry.733439703=${encodeURIComponent(json.fileUrl)}`;
            }
        } catch (err) { alert("Error de red"); b.disabled = false; b.innerText = "REINTENTAR"; }
    };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salida de Repuestos - Network Ops</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { 
            --primary: #00a1ff; 
            --dark-bg: #0f172a;
            --glass: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.15);
            --success: #22c55e;
            --warning: #fbbf24;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; 
            background: radial-gradient(circle at top right, #1e293b, var(--dark-bg));
            color: white; min-height: 100vh;
        }

        header { 
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px);
            padding: 15px 0; text-align: center; border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 2000;
        }

        h1 {
            font-family: 'Orbitron', sans-serif; margin: 0; font-size: 1.1rem;
            letter-spacing: 2px; background: linear-gradient(to bottom, #ffffff, #00a1ff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        .status-bar { font-size: 0.65rem; font-family: 'Orbitron', sans-serif; margin-top: 5px; }
        .dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-sync { background: var(--warning); animation: pulse 1s infinite; }
        .dot-ready { background: var(--success); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        .container { width: 92%; max-width: 500px; margin: 20px auto; padding-bottom: 50px; }
        .timer { 
            text-align: center; font-family: 'Orbitron', sans-serif; 
            font-size: 1.6rem; color: var(--primary); margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0, 161, 255, 0.4);
        }

        .card { 
            background: var(--glass); backdrop-filter: blur(15px);
            border: 1px solid var(--border); border-radius: 20px; padding: 22px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        label { display: block; margin-top: 18px; font-size: 0.65rem; color: var(--primary); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        
        input, select { 
            width: 100%; padding: 14px; margin-top: 6px; border-radius: 12px; 
            border: 1px solid var(--border); background: rgba(255,255,255,0.05);
            color: white; outline: none; box-sizing: border-box; font-size: 0.95rem;
        }

        input:focus { border-color: var(--primary); background: rgba(255,255,255,0.1); }
        .readonly { background: rgba(0,0,0,0.3); color: #aaa; border-style: dashed; cursor: not-allowed; }

        /* Buscador / Sugerencias Estilo Consultor */
        .search-container { position: relative; }
        .suggestions { 
            position: absolute; top: 100%; left: 0; right: 0; 
            background: #1e293b; border: 1px solid var(--primary); 
            border-radius: 12px; max-height: 220px; overflow-y: auto; z-index: 3000;
            display: none; margin-top: 5px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .suggestion-item { padding: 14px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 0.9rem; }
        .suggestion-item:hover { background: rgba(0, 161, 255, 0.15); color: var(--primary); }
        .suggestion-item strong { color: #fff; }

        button { 
            width: 100%; padding: 18px; border-radius: 16px; border: none;
            background: linear-gradient(135deg, var(--primary), #0072ff);
            color: white; font-family: 'Orbitron', sans-serif; font-weight: bold;
            margin-top: 30px; cursor: pointer; transition: 0.3s; font-size: 0.9rem;
            letter-spacing: 1px;
        }
        button:hover { filter: brightness(1.2); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,161,255,0.4); }
        button:disabled { background: #444; opacity: 0.6; cursor: not-allowed; }

        .hidden { display: none; }
        .nav-link { text-align: center; display: block; margin-top: 20px; color: #64748b; text-decoration: none; font-size: 0.8rem; }
    </style>
</head>
<body>

<header>
    <h1>SALIDA DE REPUESTOS</h1>
    <div class="status-bar">
        <span id="status-dot" class="dot dot-sync"></span>
        <span id="status-text">Sincronizando Base de Datos...</span>
    </div>
</header>

<div class="container">
    <div class="timer" id="reloj">00:00:00</div>

    <div class="card" id="consentimiento">
        <h2 style="font-family: 'Orbitron'; font-size: 1rem; text-align: center; color: var(--primary);">AUTORIZACI√ìN</h2>
        <p style="text-align: center; font-size: 0.85rem; color: #cbd5e1; line-height: 1.5;">
            Para proceder, el sistema registrar√° su usuario y requiere acceso para guardar evidencias fotogr√°ficas en su unidad de Drive personal.
        </p>
        <button onclick="activarFormulario()">ACEPTAR Y CONTINUAR</button>
    </div>

    <form id="mainForm" class="hidden">
        <div class="card">
            <label>1. Bodega de Retiro</label>
            <select id="bodega" required>
                <option value="">Seleccione bodega...</option>
                <option value="SAN BENITO">SAN BENITO</option>
                <option value="CENTRAL">CENTRAL</option>
                <option value="TALNIQUE">TALNIQUE</option>
            </select>

            <div class="search-container">
                <label>2. Nombre del Sitio (Buscador)</label>
                <input type="text" id="siteSearch" placeholder="üîç ID o Nombre del sitio..." autocomplete="off" required>
                <div id="siteSug" class="suggestions"></div>
            </div>

            <label>3. ID Sitio (Auto)</label>
            <input type="text" id="idSitio" class="readonly" readonly required>

            <div class="search-container">
                <label>4. Descripci√≥n de Equipo (Buscador)</label>
                <input type="text" id="equipoSearch" placeholder="üîç Escriba repuesto..." autocomplete="off" required>
                <div id="equipoSug" class="suggestions"></div>
            </div>

            <label>5. Marca (Auto)</label>
            <input type="text" id="marca" class="readonly" readonly required>

            <label>6. N√∫mero de Serie</label>
            <input type="text" id="serie" placeholder="Ingrese S/N" required>

            <label>7. Fotograf√≠a de Respaldo</label>
            <input type="file" id="foto" accept="image/*" required>

            <button type="submit" id="btnEnviar">ENVIAR REGISTRO</button>
            <a href="index.html" class="nav-link">‚Üê Volver al Men√∫ Principal</a>
        </div>
    </form>
</div>

<script>
    // --- CONFIGURACI√ìN DE ENLACES ---
    const CONFIG = {
        URL_SITIOS_CSV: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_5CZtD7qHGW5cWHGAjn7ALTphVm5h88lco9cySYoAe2VBW4fq8DQ7-SZY6cd_FHtNQJS3MpE88hs/pub?gid=1955381502&single=true&output=csv',
        URL_APPS_SCRIPT: 'TU_URL_DE_APPS_SCRIPT_AQUI',
        URL_FORMS_EXTERNO: 'https://docs.google.com/forms/d/e/TU_ID_DE_FORMS/viewform'
    };

    let sites = [];
    let equipos = [];

    // Reloj El Salvador (UTC-6)
    setInterval(() => {
        document.getElementById('reloj').innerText = new Date().toLocaleTimeString("es-SV", {
            timeZone: "America/El_Salvador", hour12: false
        });
    }, 1000);

    // Procesador de CSV (L√≥gica id√©ntica al consultor de sitio)
    function parseCSV(data) {
        const rows = data.split(/\r?\n/).filter(row => row.trim().length > 0);
        const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
        return rows.slice(1).map(row => {
            const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            let obj = {};
            headers.forEach((h, i) => obj[h] = values[i] ? values[i].trim().replace(/"/g, '') : '');
            return obj;
        });
    }

    async function cargarDatos() {
        try {
            // Cargar Sitios
            const resS = await fetch(CONFIG.URL_SITIOS_CSV);
            const rawS = await resS.text();
            sites = parseCSV(rawS);
            document.getElementById('status-dot').className = "dot dot-ready";
            document.getElementById('status-text').innerText = "SISTEMA SINCRONIZADO";

            // Cargar Repuestos (CSV local en GitHub)
            Papa.parse("inventario_repuestos.csv", {
                download: true, header: true, delimiter: ";",
                complete: (results) => { equipos = results.data; }
            });
        } catch (e) {
            document.getElementById('status-text').innerText = "ERROR DE CONEXI√ìN";
        }
    }

    function activarFormulario() {
        document.getElementById('consentimiento').classList.add('hidden');
        document.getElementById('mainForm').classList.remove('hidden');
        cargarDatos();
    }

    // BUSCADOR DE SITIOS (Misma "Memoria" que el consultor)
    const sInput = document.getElementById('siteSearch');
    const sSug = document.getElementById('siteSug');

    sInput.addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase().trim();
        if (val.length < 2) { sSug.style.display = 'none'; return; }
        const matches = sites.filter(s => 
            (s.SITEID && s.SITEID.toLowerCase().includes(val)) || 
            (s['NOMBRE DE SITIO'] && s['NOMBRE DE SITIO'].toLowerCase().includes(val))
        ).slice(0, 6);
        
        sSug.innerHTML = matches.map(s => `
            <div class="suggestion-item" onclick="selectSitio('${s.SITEID}', '${s['NOMBRE DE SITIO']}')">
                <strong>${s.SITEID}</strong><br><small>${s['NOMBRE DE SITIO']}</small>
            </div>
        `).join('');
        sSug.style.display = matches.length ? 'block' : 'none';
    });

    function selectSitio(id, nombre) {
        sInput.value = nombre;
        document.getElementById('idSitio').value = id;
        sSug.style.display = 'none';
    }

    // BUSCADOR DE EQUIPOS (Misma l√≥gica)
    const eInput = document.getElementById('equipoSearch');
    const eSug = document.getElementById('equipoSug');

    eInput.addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase().trim();
        if (val.length < 2) { eSug.style.display = 'none'; return; }
        const matches = equipos.filter(eq => 
            eq.Descripcion && eq.Descripcion.toLowerCase().includes(val)
        ).slice(0, 6);

        eSug.innerHTML = matches.map(eq => `
            <div class="suggestion-item" onclick="selectEquipo('${eq.Descripcion}', '${eq.Marca}')">
                <strong>${eq.Descripcion}</strong><br><small>Marca: ${eq.Marca}</small>
            </div>
        `).join('');
        eSug.style.display = matches.length ? 'block' : 'none';
    });

    function selectEquipo(desc, marca) {
        eInput.value = desc;
        document.getElementById('marca').value = marca;
        eSug.style.display = 'none';
    }

    // --- ENV√çO A SHEET + REDIRECCI√ìN A FORMS ---
    document.getElementById('mainForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnEnviar');
        btn.disabled = true; 
        btn.innerText = "REGISTRANDO EN BASE DE DATOS...";

        const fileInput = document.getElementById('foto');
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function() {
            const base64 = reader.result.split(',')[1];
            const data = {
                fileData: base64, fileName: file.name, mimeType: file.type,
                bodega: document.getElementById('bodega').value,
                idSitio: document.getElementById('idSitio').value,
                nombreSitio: document.getElementById('siteSearch').value,
                descripcion: document.getElementById('equipoSearch').value,
                marca: document.getElementById('marca').value,
                serie: document.getElementById('serie').value
            };

            try {
                // 1. Enviar a tu Google Apps Script
                const resp = await fetch(CONFIG.URL_APPS_SCRIPT, {
                    method: 'POST',
                    body: new URLSearchParams(data)
                });
                const res = await resp.json();

                if (res.result === "success") {
                    btn.innerText = "ABRIENDO FORMULARIO EXTERNO...";
                    
                    // 2. Construir URL de pre-llenado con tus entry.xxx
                    const prefilledUrl = `${CONFIG.URL_FORMS_EXTERNO}?entry.795516044=${encodeURIComponent(data.bodega)}&entry.1265319450=${encodeURIComponent(data.idSitio)}&entry.1509520939=${encodeURIComponent(data.nombreSitio)}&entry.554570123=${encodeURIComponent(data.marca)}&entry.1914147166=${encodeURIComponent(data.descripcion)}&entry.1497572830=${encodeURIComponent(data.serie)}&entry.733439703=${encodeURIComponent(res.fileUrl)}`;
                    
                    // 3. Redirigir
                    window.location.href = prefilledUrl;
                }
            } catch (err) {
                alert("Error de conexi√≥n. Verifique el Script de Google.");
                btn.disabled = false;
                btn.innerText = "REINTENTAR ENV√çO";
            }
        };
        reader.readAsDataURL(file);
    };

    // Cerrar sugerencias al hacer clic fuera
    document.addEventListener('click', (e) => {
        if (!sInput.contains(e.target)) sSug.style.display = 'none';
        if (!eInput.contains(e.target)) eSug.style.display = 'none';
    });
</script>

</body>
</html>

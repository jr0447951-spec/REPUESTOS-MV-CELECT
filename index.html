<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loading { cursor: not-allowed; opacity: 0.6; }
  </style>
</head>
<body class="bg-gray-100 p-4 font-sans">

  <div class="max-w-md mx-auto bg-white rounded-xl shadow-md p-6 border border-gray-200">
    <h2 class="text-xl font-bold text-blue-600 mb-4 text-center border-b pb-2">Registro de Movimiento</h2>
    
    <form id="registroForm" onsubmit="enviarDatos(event)">
      
      <div class="mb-4">
        <label class="block text-sm font-bold mb-1">ID y Nombre del Sitio:</label>
        <input type="text" name="idSitio" placeholder="ID Sitio" class="w-1/3 p-2 border rounded-l-lg outline-none" required>
        <input type="text" name="nombreSitio" placeholder="Nombre" class="w-2/3 p-2 border-y border-r rounded-r-lg outline-none" required>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-bold mb-1">Repuesto / Modelo:</label>
        <input type="text" name="repuesto" placeholder="Equipo" class="w-full p-2 border rounded-lg mb-2" required>
        <div class="flex gap-2">
          <input type="text" name="modelo" placeholder="Modelo" class="w-1/2 p-2 border rounded-lg">
          <input type="text" name="marca" placeholder="Marca" class="w-1/2 p-2 border rounded-lg">
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-bold mb-1">Activo / Serie:</label>
        <div class="flex gap-2">
          <input type="text" name="activo" placeholder="N° Activo" class="w-1/2 p-2 border rounded-lg">
          <input type="text" name="serie" placeholder="N° Serie" class="w-1/2 p-2 border rounded-lg">
        </div>
      </div>

      <div class="mb-4 grid grid-cols-2 gap-2">
        <div>
          <label class="block text-sm font-bold mb-1">Técnico:</label>
          <input type="text" name="tecnicoRetira" placeholder="Nombre" class="w-full p-2 border rounded-lg" required>
        </div>
        <div>
          <label class="block text-sm font-bold mb-1">Bodega:</label>
          <input type="text" name="bodega" placeholder="Bodega" class="w-full p-2 border rounded-lg">
        </div>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-bold mb-1 text-blue-600">Subir Evidencia (Foto):</label>
        <input type="file" id="archivo" accept="image/*" capture="camera" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>

      <button type="submit" id="btnEnviar" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">
        Guardar Registro
      </button>

    </form>
    
    <div id="status" class="mt-4 text-center font-bold hidden"></div>
  </div>

  <script>
    function enviarDatos(e) {
      e.preventDefault();
      const form = document.getElementById('registroForm');
      const btn = document.getElementById('btnEnviar');
      const status = document.getElementById('status');
      const fileInput = document.getElementById('archivo');

      btn.disabled = true;
      btn.classList.add('loading');
      btn.innerText = "Enviando...";
      status.classList.remove('hidden', 'text-red-600', 'text-green-600');
      status.innerText = "Procesando datos e imagen...";

      const formData = {
        idSitio: form.idSitio.value,
        nombreSitio: form.nombreSitio.value,
        repuesto: form.repuesto.value,
        modelo: form.modelo.value,
        marca: form.marca.value,
        activo: form.activo.value,
        serie: form.serie.value,
        tecnicoRetira: form.tecnicoRetira.value,
        bodega: form.bodega.value
      };

      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const bytes = e.target.result.split(',')[1];
          // LLAMADA AL SERVIDOR (.gs)
          google.script.run
            .withSuccessHandler(res => finalizar(res))
            .guardarRegistroTécnico(formData, bytes, file.name);
        };
        reader.readAsDataURL(file);
      } else {
        google.script.run
          .withSuccessHandler(res => finalizar(res))
          .guardarRegistroTécnico(formData, null, null);
      }
    }

    function finalizar(res) {
      const status = document.getElementById('status');
      const btn = document.getElementById('btnEnviar');
      btn.disabled = false;
      btn.classList.remove('loading');
      btn.innerText = "Guardar Registro";

      if (res === "OK") {
        status.innerText = "✅ ¡Guardado con éxito!";
        status.classList.add('text-green-600');
        document.getElementById('registroForm').reset();
      } else {
        status.innerText = "❌ " + res;
        status.classList.add('text-red-600');
      }
    }
  </script>
</body>
</html>

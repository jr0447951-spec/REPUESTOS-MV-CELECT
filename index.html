<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CELECT Movistar</title>
    <style>
        :root { --p: #0056b3; --s: #28a745; --d: #343a40; }
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        .container { max-width: 450px; margin: auto; }
        .btn-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-op { flex: 1; padding: 20px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; }
        .retiro { background: var(--p); }
        .entrega { background: var(--s); }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
        label { display: block; margin-top: 12px; font-weight: bold; font-size: 13px; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .btn-send { width: 100%; padding: 15px; margin-top: 20px; border: none; border-radius: 6px; background: var(--d); color: white; font-weight: bold; }
        .loader { position: fixed; top:0; left:0; width:100%; height:100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 9; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="loading" class="loader"><b>‚åõ Conectando con Google Sheets...</b></div>

<div class="container">
    <div id="user-tag" style="text-align: right; font-size: 11px; margin-bottom: 5px;"></div>
    <div class="btn-box">
        <button class="btn-op retiro" onclick="setModo('RETIRO')">üì§ RETIRO</button>
        <button class="btn-op entrega" onclick="setModo('ENTREGA')">üì• ENTREGA</button>
    </div>

    <div id="main-card" class="card">
        <h2 id="title-modo" style="margin:0 0 15px 0;"></h2>
        <form id="formRepo">
            <div id="div-bodega"><label>Bodega:</label><select id="bodega"><option>BODEGA CENTRAL</option><option>SAN BENITO</option></select></div>
            
            <label>Sitio:</label><select id="selSitio" onchange="actualizarEquipos()"></select>
            <label>Equipo:</label><select id="selEquipo" onchange="setSerie()"></select>
            <label>Serie:</label><input type="text" id="serie">
            <div id="div-af" class="hidden"><label>Activo Fijo:</label><input type="text" id="af"></div>
            <label>Foto:</label><input type="file" id="foto" accept="image/*" capture="camera">
            
            <button type="button" onclick="enviar()" class="btn-send" id="btnGo">REGISTRAR</button>
        </form>
    </div>
</div>

<script>
    let DATA = {}; let MODO = "";
    // ‚ö†Ô∏è REEMPLAZA ESTA URL CON TU /exec NUEVO
    const URL_APPS = "https://script.google.com/macros/s/AKfycbxWzd00EE_8YlU8-DiZiQoYOSFMfeyFNefYz4vgkCRt-pncINKdbs_fDs7Z7QQtowR6/exec";

    window.onload = () => {
        fetch(URL_APPS + "?accion=leerData")
            .then(r => r.text()) // Leemos como texto para saltar CORS
            .then(t => {
                DATA = JSON.parse(t);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('user-tag').innerText = "Usuario: " + DATA.usuarioActual.nombre;
                const sel = document.getElementById('selSitio');
                sel.innerHTML = '<option value="">-- Seleccione --</option>';
                for (const [nom, id] of Object.entries(DATA.sitios)) {
                    sel.innerHTML += `<option value="${id}" data-nom="${nom}">${id} - ${nom}</option>`;
                }
            })
            .catch(e => { document.getElementById('loading').innerText = "‚ùå Error de conexi√≥n"; });
    };

    function setModo(m) {
        MODO = m;
        document.getElementById('main-card').style.display = 'block';
        document.getElementById('title-modo').innerText = m;
        document.getElementById('div-bodega').style.display = m === 'RETIRO' ? 'block' : 'none';
        document.getElementById('div-af').style.display = m === 'ENTREGA' ? 'block' : 'none';
        document.getElementById('serie').readOnly = m === 'ENTREGA';
    }

    function actualizarEquipos() {
        const id = document.getElementById('selSitio').value;
        const sel = document.getElementById('selEquipo');
        sel.innerHTML = '<option value="">-- Seleccione --</option>';
        if (MODO === 'ENTREGA') {
            DATA.pendientes.filter(p => p.siteId == id).forEach(p => {
                sel.innerHTML += `<option value="${p.serie}" data-nom="${p.equipo}">${p.equipo} (SN: ${p.serie})</option>`;
            });
        } else {
            for (const [desc, marca] of Object.entries(DATA.inventario)) {
                sel.innerHTML += `<option value="${desc}" data-marca="${marca}">${desc}</option>`;
            }
        }
    }

    function setSerie() { 
        if(MODO === 'ENTREGA') document.getElementById('serie').value = document.getElementById('selEquipo').value; 
    }

    function enviar() {
        const btn = document.getElementById('btnGo');
        const f = document.getElementById('foto').files[0];
        if(!f) return alert("Suba una foto");
        
        btn.disabled = true; btn.innerText = "ENVIANDO...";
        const r = new FileReader();
        r.readAsDataURL(f);
        r.onload = () => {
            const payload = {
                accion: MODO === 'RETIRO' ? 'guardarRetiro' : 'guardarEntrega',
                datos: {
                    idSitio: document.getElementById('selSitio').value,
                    nombreSitio: document.getElementById('selSitio').options[document.getElementById('selSitio').selectedIndex].dataset.nom,
                    equipo: MODO === 'RETIRO' ? document.getElementById('selEquipo').value : document.getElementById('selEquipo').options[document.getElementById('selEquipo').selectedIndex].dataset.nom,
                    serie: document.getElementById('serie').value,
                    bodega: document.getElementById('bodega').value,
                    marca: document.getElementById('selEquipo').options[document.getElementById('selEquipo').selectedIndex].dataset.marca || "",
                    activoFijo: document.getElementById('af').value,
                    tecnico: DATA.usuarioActual.nombre
                },
                bytes: r.result.split(',')[1],
                fileName: f.name
            };
            
            fetch(URL_APPS, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                .then(() => { alert("√âxito"); location.reload(); });
        };
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CELECT PRO - GestiÃ³n</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        :root { --p: #0056b3; --s: #28a745; --d: #343a40; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: auto; }
        .user-info { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 12px; display: flex; justify-content: space-between; border-left: 4px solid var(--p); }
        .btn-box { display: flex; gap: 8px; margin-bottom: 15px; }
        .btn-op { flex: 1; padding: 15px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 13px; color: #444; }
        input, .select2-container { width: 100% !important; margin-top: 5px; }
        .select2-selection { height: 45px !important; border-radius: 8px !important; border: 1px solid #ccc !important; padding-top: 8px !important; }
        .btn-send { width: 100%; padding: 16px; margin-top: 25px; border: none; border-radius: 8px; background: var(--d); color: white; font-weight: bold; font-size: 16px; cursor: pointer; }
        .loader { position: fixed; top:0; left:0; width:100%; height:100%; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99; }
        .admin-only { display: none; background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div id="loading" class="loader"><b>âŒ› Cargando Sistema y Roles...</b></div>

<div class="container">
    <div class="user-info">
        <span id="u-nom">...</span>
        <span id="u-rol" style="font-weight: bold; color: var(--p);">...</span>
    </div>
    
    <div id="admin-panel" class="admin-only">
        <b>Panel Admin:</b> Usted puede ver todos los movimientos.
    </div>

    <div class="btn-box" id="menu-ops">
        <button class="btn-op" style="background:var(--p)" onclick="setModo('RETIRO')">ðŸ“¤ RETIRO</button>
        <button class="btn-op" style="background:var(--s)" onclick="setModo('ENTREGA')">ðŸ“¥ ENTREGA</button>
    </div>

    <div id="main-card" class="card">
        <h3 id="title-modo" style="margin-top:0"></h3>
        <form id="formRepo">
            <div id="div-bodega">
                <label>Bodega de Origen:</label>
                <select id="bodega" class="js-basic"><option>BODEGA CENTRAL</option><option>BODEGA SAN BENITO</option><option>BODEGA TALNIQUE</option></select>
            </div>
            
            <label>Sitio (Escriba nombre o ID):</label>
            <select id="selSitio" class="js-search" required onchange="actualizarEquipos()"></select>
            
            <label>DescripciÃ³n del Equipo:</label>
            <select id="selEquipo" class="js-search" required onchange="setSerie()"></select>
            
            <label>NÃºmero de Serie:</label>
            <input type="text" id="serie" required>
            
            <label>Activo Fijo:</label>
            <input type="text" id="af" placeholder="N/A">
            
            <label>Foto Evidencia:</label>
            <input type="file" id="foto" accept="image/*" capture="camera" required>
            
            <button type="button" onclick="enviar()" class="btn-send" id="btnGo">FINALIZAR REGISTRO</button>
            <div id="status" style="text-align:center; margin-top:10px;"></div>
        </form>
    </div>
</div>

<script>
    let DATA = {}; let MODO = "";
    const URL_APPS = "https://script.google.com/macros/s/AKfycbxXKcr24FzBuPsGCLCmzFI9ZQ6njT2eK_6RJFsnIv1o0X4EewO2CAbQujpY5dfqTKzA/exec";

    $(document).ready(function() {
        $('.js-search').select2();
        cargarDatos();
    });

    function cargarDatos() {
        fetch(URL_APPS + "?accion=leerData")
            .then(r => r.text())
            .then(t => {
                DATA = JSON.parse(t);
                document.getElementById('loading').style.display = 'none';
                
                // Aplicar Roles
                document.getElementById('u-nom').innerText = DATA.usuarioActual.nombre;
                document.getElementById('u-rol').innerText = DATA.usuarioActual.rol;
                
                if(DATA.usuarioActual.rol === "ADMIN_EDIT" || DATA.usuarioActual.rol === "ADMIN_VIEW") {
                    document.getElementById('admin-panel').style.display = 'block';
                }
                if(DATA.usuarioActual.rol === "ADMIN_VIEW") {
                    document.getElementById('menu-ops').style.display = 'none';
                    document.getElementById('status').innerText = "Modo solo lectura.";
                }

                // Cargar Sitios al Select2
                const sel = $('#selSitio');
                sel.append('<option value="">Buscar sitio...</option>');
                DATA.sitios.forEach(s => {
                    sel.append(new Option(s.text, s.id, false, false));
                });
            });
    }

    function setModo(m) {
        MODO = m;
        $('#main-card').fadeIn();
        document.getElementById('title-modo').innerText = "OperaciÃ³n: " + m;
        document.getElementById('div-bodega').style.display = m === 'RETIRO' ? 'block' : 'none';
        document.getElementById('serie').readOnly = (m === 'ENTREGA');
        actualizarEquipos();
    }

    function actualizarEquipos() {
        const id = $('#selSitio').val();
        const sel = $('#selEquipo');
        sel.empty().append('<option value="">Buscar equipo...</option>');
        
        if (MODO === 'ENTREGA') {
            DATA.pendientes.filter(p => p.siteId == id).forEach(p => {
                sel.append(new Option(`${p.equipo} (SN: ${p.serie})`, p.serie, false, false));
            });
        } else {
            DATA.inventario.forEach(i => {
                const opt = new Option(i.text, i.id, false, false);
                $(opt).data('marca', i.marca);
                sel.append(opt);
            });
        }
    }

    function setSerie() { 
        if(MODO === 'ENTREGA') document.getElementById('serie').value = $('#selEquipo').val(); 
    }

    function enviar() {
        const btn = document.getElementById('btnGo');
        const f = document.getElementById('foto').files[0];
        if(!$('#selSitio').val() || !f) return alert("Faltan datos");

        btn.disabled = true; btn.innerText = "ENVIANDO...";
        const r = new FileReader();
        r.readAsDataURL(f);
        r.onload = () => {
            const payload = {
                accion: MODO === 'RETIRO' ? 'guardarRetiro' : 'guardarEntrega',
                datos: {
                    idSitio: $('#selSitio').val(),
                    nombreSitio: DATA.sitios.find(s => s.id == $('#selSitio').val()).nombre,
                    equipo: MODO === 'RETIRO' ? $('#selEquipo').val() : $('#selEquipo').find(':selected').text().split(' (')[0],
                    serie: document.getElementById('serie').value,
                    bodega: document.getElementById('bodega').value,
                    marca: $('#selEquipo').find(':selected').data('marca') || "ZTE",
                    activoFijo: document.getElementById('af').value || "N/A",
                    tecnico: DATA.usuarioActual.nombre,
                    correo: DATA.usuarioActual.correo
                },
                bytes: r.result.split(',')[1],
                fileName: f.name
            };
            fetch(URL_APPS, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                .then(() => { alert("Registro exitoso"); location.reload(); });
        };
    }
</script>
</body>
</html>

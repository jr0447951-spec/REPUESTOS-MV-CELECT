<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CELECT Movistar - Gesti√≥n</title>
    <style>
        :root { --p: #0056b3; --s: #28a745; --d: #343a40; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        .container { max-width: 450px; margin: auto; }
        .btn-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-op { flex: 1; padding: 20px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        .retiro { background: var(--p); box-shadow: 0 4px 10px rgba(0,86,179,0.2); }
        .entrega { background: var(--s); box-shadow: 0 4px 10px rgba(40,167,69,0.2); }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 13px; color: #444; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        input[readonly] { background: #eee; }
        .btn-send { width: 100%; padding: 15px; margin-top: 25px; border: none; border-radius: 8px; background: var(--d); color: white; font-weight: bold; font-size: 16px; cursor: pointer; }
        .loader { position: fixed; top:0; left:0; width:100%; height:100%; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="loading" class="loader">
    <div style="font-size: 40px;">‚è≥</div>
    <p id="msg-carga">Sincronizando con CELECT Cloud...</p>
</div>

<div class="container">
    <div id="user-tag" style="text-align: right; font-size: 12px; margin-bottom: 10px; color: #666;"></div>
    
    <div class="btn-box">
        <button class="btn-op retiro" onclick="setModo('RETIRO')">üì§ RETIRO</button>
        <button class="btn-op entrega" onclick="setModo('ENTREGA')">üì• ENTREGA</button>
    </div>

    <div id="main-card" class="card">
        <h2 id="title-modo" style="margin:0 0 15px 0; color: var(--d);"></h2>
        <form id="formRepo">
            <div id="div-bodega">
                <label>Bodega de Origen:</label>
                <select id="bodega">
                    <option>BODEGA CENTRAL</option>
                    <option>BODEGA SAN BENITO</option>
                    <option>BODEGA TALNIQUE</option>
                </select>
            </div>
            
            <label>Sitio (ID - Nombre):</label>
            <select id="selSitio" required onchange="actualizarEquipos()"></select>
            
            <label>Equipo:</label>
            <select id="selEquipo" required onchange="setSerie()"></select>
            
            <label>N√∫mero de Serie:</label>
            <input type="text" id="serie" required>
            
            <div id="div-af" class="hidden">
                <label>Activo Fijo:</label>
                <input type="text" id="af" placeholder="Ingrese placa de activo">
            </div>
            
            <label>Foto Evidencia:</label>
            <input type="file" id="foto" accept="image/*" capture="camera" required>
            
            <button type="button" onclick="enviar()" class="btn-send" id="btnGo">REGISTRAR OPERACI√ìN</button>
            <div id="status" style="text-align:center; margin-top:10px;"></div>
        </form>
    </div>
</div>

<script>
    let DATA = {}; 
    let MODO = "";
    // ‚ö†Ô∏è REEMPLAZA CON TU URL DE /exec ACTUALIZADA
    const URL_APPS = "https://script.google.com/macros/s/AKfycbxyx4yXVmS4BY42UA_Dbx8wIdPQoCInktZqv0tnYNdogtI2wLEFvHkNYvWEJb9nVbhM/exec";

    window.onload = () => {
    const msg = document.getElementById('msg-carga');
    
    // Agregamos un par√°metro de tiempo para evitar que el navegador use datos viejos
    const urlConCache = URL_APPS + "?accion=leerData&t=" + Date.now();

    console.log("Iniciando conexi√≥n a:", urlConCache);

    fetch(urlConCache)
        .then(response => {
            console.log("Respuesta recibida del servidor...");
            if (!response.ok) throw new Error("Servidor no disponible (Status: " + response.status + ")");
            return response.text(); // Leemos como texto puro
        })
        .then(texto => {
            console.log("Texto recibido, intentando procesar...");
            try {
                DATA = JSON.parse(texto); // Convertimos el texto a datos reales aqu√≠
                
                if (DATA.error) throw new Error(DATA.error);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('user-tag').innerText = "T√©cnico: " + (DATA.usuarioActual.nombre || "Autorizado");
                
                // Llenar sitios
                const sel = document.getElementById('selSitio');
                sel.innerHTML = '<option value="">-- Seleccione Sitio --</option>';
                for (const [nom, id] of Object.entries(DATA.sitios)) {
                    sel.innerHTML += `<option value="${id}" data-nom="${nom}">${id} - ${nom}</option>`;
                }
                console.log("Sincronizaci√≥n completa.");
            } catch (e) {
                console.error("Fallo al procesar datos:", e);
                throw new Error("El servidor envi√≥ datos da√±ados.");
            }
        })
        .catch(err => {
            console.error("Error final:", err);
            msg.innerHTML = `<b style="color:red">ERROR DE SINCRONIZACI√ìN</b><br>
            <small>${err.message}</small><br><br>
            <button onclick="location.reload()" style="padding:10px; border-radius:5px;">Reintentar</button>`;
        });
};

    function setModo(m) {
        MODO = m;
        document.getElementById('main-card').style.display = 'block';
        document.getElementById('title-modo').innerText = "OPERACI√ìN: " + m;
        document.getElementById('div-bodega').style.display = m === 'RETIRO' ? 'block' : '

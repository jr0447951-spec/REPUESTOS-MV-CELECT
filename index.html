<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA CELECT</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 10px; margin: 0; }
        .container { max-width: 450px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 10px; display: none; }
        .header { background: #0056b3; color: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        label { display: block; margin-top: 12px; font-weight: bold; font-size: 13px; }
        input, select, .select2-container { width: 100% !important; margin-top: 5px; }
        .select2-selection { height: 40px !important; border-radius: 6px !important; padding-top: 5px !important; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index:99; }
    </style>
</head>
<body>

<div id="loading"><b>Cargando Base de Datos...</b></div>

<div class="container">
    <div class="header">
        <div id="user-name" style="font-weight: bold;">...</div>
        <div id="user-rol" style="font-size: 11px;">...</div>
    </div>

    <div class="btn-group">
        <button class="btn" style="background:#0056b3" onclick="abrir('RETIRO')">RETIRO</button>
        <button class="btn" style="background:#28a745" onclick="abrir('ENTREGA')">ENTREGA</button>
    </div>

    <div id="form-card" class="card">
        <h3 id="modo-txt" style="margin:0"></h3>
        <form id="mainForm">
            <div id="bodega-div">
                <label>Bodega:</label>
                <select id="bodega"><option>BODEGA CENTRAL</option><option>SAN BENITO</option><option>TALNIQUE</option></select>
            </div>

            <label>Sitio:</label>
            <select id="sitio" class="select2"></select>

            <label>Equipo:</label>
            <select id="equipo" class="select2"></select>

            <label>Serie:</label>
            <input type="text" id="serie" required>

            <label>Activo Fijo:</label>
            <input type="text" id="af" placeholder="N/A">

            <label>Foto:</label>
            <input type="file" id="foto" accept="image/*" capture="camera" required>

            <button type="button" onclick="enviar()" id="btnSend" class="btn" style="background:#333; width:100%; margin-top:20px;">CONFIRMAR</button>
        </form>
    </div>
</div>

<script>
    let DB = {}; let MODO = "";
    // ⚠️ REEMPLAZA ESTA URL CON LA TUYA DE GOOGLE APPS SCRIPT
    const URL_APPS = "https://script.google.com/macros/s/AKfycby6vZ_HW8iSoAVy8EOZpXa6x-bGu9lV-QCePm4jkmEsentvr_oo2gjki7zc1dsftION/exec";

    $(document).ready(() => {
        $('.select2').select2({ placeholder: "Seleccione..." });
        $('#sitio').on('change', () => filterEq($('#sitio').val()));
        $('#equipo').on('change', function() { if(MODO==='ENTREGA') $('#serie').val($(this).val()); });
        init();
    });

    async function init() {
        try {
            const r = await fetch(URL_APPS);
            DB = await r.json();
            $('#loading').hide();
            $('#user-name').text(DB.user.nombre);
            $('#user-rol').text("Rol: " + DB.user.rol);
            if(DB.user.rol === "ADMIN_VIEW") $('.btn-group').hide();
            
            DB.sitios.forEach(s => $('#sitio').append(new Option(s.txt, s.id)));
        } catch(e) { $('#loading').text("Error de conexión. Revisa los permisos."); }
    }

    function abrir(m) {
        MODO = m;
        $('#form-card').show();
        $('#modo-txt').text(m);
        $('#bodega-div').toggle(m === 'RETIRO');
        $('#serie').prop('readonly', m === 'ENTREGA');
        filterEq($('#sitio').val());
    }

    function filterEq(sid) {
        const sel = $('#equipo').empty().append(new Option("",""));
        if(MODO === 'ENTREGA') {
            DB.pends.filter(p => p.sid === sid).forEach(p => sel.append(new Option(p.eq + " ("+p.sn+")", p.sn)));
        } else {
            DB.inv.forEach(i => {
                const o = new Option(i.id, i.id);
                $(o).data('m', i.m);
                sel.append(o);
            });
        }
    }

    function enviar() {
        const f = $('#foto')[0].files[0];
        if(!$('#sitio').val() || !f) return alert("Faltan datos");

        $('#btnSend').prop('disabled', true).text("ENVIANDO...");
        const reader = new FileReader();
        reader.readAsDataURL(f);
        reader.onload = () => {
            const data = {
                accion: MODO,
                idSitio: $('#sitio').val(),
                nomSitio: DB.sitios.find(s => s.id === $('#sitio').val()).nom,
                equipo: MODO === 'RETIRO' ? $('#equipo').val() : $('#equipo').find(':selected').text().split(' (')[0],
                serie: $('#serie').val(),
                af: $('#af').val() || "N/A",
                bodega: $('#bodega').val(),
                marca: $('#equipo').find(':selected').data('m') || "N/A",
                bytes: reader.result.split(',')[1],
                fileName: f.name
            };

            fetch(URL_APPS, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
                .then(() => { alert("Registro Exitoso"); location.reload(); })
                .catch(() => { alert("Error al enviar"); $('#btnSend').prop('disabled', false); });
        };
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retorno de Equipos - CELECT-MV</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
        .group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; background-color: #1a73e8; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:disabled { background-color: #ccc; }
        #status { margin-top: 15px; text-align: center; font-size: 14px; padding: 10px; border-radius: 5px; display: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>üîÑ Registro de Entrega</h2>
    
    <div class="group">
        <label>ID del Sitio (B√∫squeda)</label>
        <input type="text" id="idSitio" placeholder="Ej: SAL001" oninput="consultarPendientes()">
    </div>

    <div class="group">
        <label>Equipo Pendiente (Filtro CSV)</label>
        <select id="equipoSelect">
            <option value="">-- Escriba ID de Sitio --</option>
        </select>
    </div>

    <div class="group">
        <label>Estado F√≠sico al Retornar</label>
        <select id="estadoFisico">
            <option value="USADO / FUNCIONAL">USADO / FUNCIONAL</option>
            <option value="DA√ëADO / AVERIADO">DA√ëADO / AVERIADO</option>
            <option value="NO UTILIZADO">NO UTILIZADO</option>
        </select>
    </div>

    <div class="group">
        <label>Confirmar Serie del Equipo</label>
        <input type="text" id="serieConfirmada" placeholder="Ingrese n√∫mero de serie f√≠sico">
    </div>

    <button id="btnRegistrar" class="btn" onclick="ejecutarEntrega()">FINALIZAR ENTREGA</button>
    <div id="status"></div>
</div>

<script>
    // CONFIGURACI√ìN DE ENLACES
    const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?output=csv";
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycby5wT1f4xxRQvBrCaMuIQzwzsXxl5tqxFREl376TNjRIYhXFjrOSU2GobJby1KJ6rYg/exec";
    const URL_FORM_RESPALDO = "https://docs.google.com/forms/d/e/1FAIpQLSfz-IGCT2vdfUplh2MipdjgBLcspDE_TWChhrWn1wBaVMnWOQ/formResponse";

    // 1. FILTRAR EQUIPOS PENDIENTES
    async function consultarPendientes() {
        const idBuscado = document.getElementById('idSitio').value.trim().toUpperCase();
        if (idBuscado.length < 3) return;

        try {
            const response = await fetch(URL_CSV);
            const data = await response.text();
            const filas = data.split("\n").map(f => f.split(","));
            const select = document.getElementById('equipoSelect');
            
            select.innerHTML = '<option value="">Seleccione el equipo...</option>';

            filas.forEach(col => {
                const idSheet = col[3]?.replace(/"/g, "").trim();    // Col D: ID Sitio
                const descSheet = col[5]?.replace(/"/g, "").trim();  // Col F: Descripci√≥n
                const estadoSheet = col[9]?.replace(/"/g, "").trim(); // Col J: Estado

                if (idSheet === idBuscado && estadoSheet === "PENDIENTE") {
                    let opt = document.createElement('option');
                    opt.value = descSheet;
                    opt.textContent = descSheet;
                    select.appendChild(opt);
                }
            });
        } catch (e) { console.error("Error leyendo CSV:", e); }
    }

    // 2. PROCESO DE ENTREGA (DOBLE ENV√çO)
    async function ejecutarEntrega() {
        const id = document.getElementById('idSitio').value;
        const equipo = document.getElementById('equipoSelect').value;
        const estado = document.getElementById('estadoFisico').value;
        const serie = document.getElementById('serieConfirmada').value;
        const statusDiv = document.getElementById('status');
        const btn = document.getElementById('btnRegistrar');

        if (!equipo || !serie) {
            alert("Por favor, seleccione el equipo y confirme la serie.");
            return;
        }

        btn.disabled = true;
        statusDiv.style.display = "block";
        statusDiv.style.backgroundColor = "#fff3cd";
        statusDiv.innerHTML = "‚åõ Registrando en Google Sheets y Formulario...";

        try {
            // A. ENV√çO AL GOOGLE FORM (RESPALDO EXTERNO)
            const formParams = new URLSearchParams();
            formParams.append("entry.821288735", id);        // ID Sitio
            formParams.append("entry.1467261011", equipo);    // Descripci√≥n
            formParams.append("entry.1183702054", serie);     // Serie
            // Nota: Se usa no-cors para Google Forms
            fetch(`${URL_FORM_RESPALDO}?${formParams.toString()}`, { mode: 'no-cors' });

            // B. ENV√çO AL APPS SCRIPT (ACTUALIZACI√ìN DE FILA)
            const scriptParams = new URLSearchParams();
            scriptParams.append("action", "entregar");
            scriptParams.append("descripcion", equipo);
            scriptParams.append("estado", estado);
            scriptParams.append("serie", serie);

            const resScript = await fetch(URL_SCRIPT + "?" + scriptParams.toString(), { method: 'POST' });
            const resultText = await resScript.text();

            if (resultText.includes("EXITOSA")) {
                statusDiv.style.backgroundColor = "#d4edda";
                statusDiv.innerHTML = "‚úÖ ¬°ENTREGA REGISTRADA!<br>Fila actualizada y respaldo enviado.";
                setTimeout(() => location.reload(), 3000);
            } else {
                throw new Error(resultText);
            }

        } catch (e) {
            statusDiv.style.backgroundColor = "#f8d7da";
            statusDiv.innerHTML = "‚ùå ERROR: " + e.message;
            btn.disabled = false;
        }
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENTREGA CELECT-MV</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; max-width: 480px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .section { border-left: 4px solid #1a73e8; padding-left: 15px; margin-bottom: 20px; }
        h3 { font-size: 11px; color: #888; text-transform: uppercase; margin: 0 0 10px 0; }
        label { display: block; font-weight: bold; margin: 10px 0 5px; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-opt { padding: 12px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 12px; }
        .btn-opt.active { background: #1a73e8; color: white; border-color: #1a73e8; }
        .btn-submit { width: 100%; padding: 18px; background: #27ae60; color: white; border: none; border-radius: 10px; font-size: 17px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center; color:#1a73e8;">Registro de Entrega</h2>

    <div class="section">
        <h3>Secci√≥n 1: Identificaci√≥n</h3>
        <label>T√©cnico (Col. B)</label>
        <input type="text" id="tecnico_nombre" placeholder="Nombre de quien recibe">
        
        <label>Nombre del Sitio (Col. C)</label>
        <input type="text" id="sitio_nombre" placeholder="Buscar sitio..." oninput="autoId()">
        
        <label>ID SITIO (Col. D)</label>
        <input type="text" id="sitio_id" readonly style="background:#eee;">
    </div>

    <div class="section">
        <h3>Secci√≥n 2: Estado (Col. E)</h3>
        <div class="grid">
            <button type="button" class="btn-opt" onclick="setEstado('DA√ëADO', this)">DA√ëADO</button>
            <button type="button" class="btn-opt" onclick="setEstado('NO UTILIZADO', this)">NO UTILIZADO</button>
            <button type="button" class="btn-opt" onclick="setEstado('USADO', this)">USADO</button>
            <button type="button" class="btn-opt" onclick="setEstado('POR REPARACI√ìN', this)">REPARACI√ìN</button>
        </div>
        <input type="hidden" id="equipo_estado">
    </div>

    <div class="section">
        <h3>Secci√≥n 3: Datos del Equipo</h3>
        <div id="box_ref" style="display:none;">
            <label>Referencia Salida (Col. F)</label>
            <select id="ref_salida_desc" onchange="llenarDesdeSalida()"></select>
        </div>
        
        <label>Descripci√≥n (Col. G)</label>
        <input type="text" id="equipo_desc" list="lista_repo" placeholder="Buscar repuesto..." onchange="autoMarca()">
        <datalist id="lista_repo"></datalist>
        
        <label>Marca (Col. H)</label>
        <input type="text" id="equipo_marca" readonly style="background:#eee;">
        
        <label>Serie (Col. J) - MANUAL</label>
        <input type="text" id="equipo_serie" placeholder="Ingrese serie f√≠sica">
    </div>

    <div class="section">
        <h3>Secci√≥n 4: Recepci√≥n</h3>
        <label>Bodega (Col. I)</label>
        <div class="grid">
            <button type="button" class="btn-opt" onclick="setBodega('SAN BENITO', this)">SB</button>
            <button type="button" class="btn-opt" onclick="setBodega('CENTRAL', this)">CE</button>
            <button type="button" class="btn-opt" onclick="setBodega('TALNIQUE', this)">TA</button>
        </div>
        <input type="hidden" id="bodega_destino">

        <label>Comentarios (Col. K)</label>
        <textarea id="comentarios" rows="2"></textarea>
    </div>

    <button class="btn-submit" onclick="enviar()">üöÄ FINALIZAR Y ENVIAR</button>
</div>

<script>
    const CSV_SALIDAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?output=csv";
    const CSV_REPUESTOS = "inventario_repuestos.csv";
    let dbS = [], dbR = [];

    window.onload = async () => {
        const [r1, r2] = await Promise.all([fetch(CSV_SALIDAS), fetch(CSV_REPUESTOS)]);
        const [t1, t2] = await Promise.all([r1.text(), r2.text()]);
        dbS = t1.split("\n").map(l => l.split(",").map(c => c.replace(/"/g,"").trim()));
        dbR = t2.split("\n").map(l => l.split(",").map(c => c.replace(/"/g,"").trim()));
        
        const list = document.getElementById('lista_repo');
        dbR.slice(1).forEach(r => { if(r[0]) { let o=document.createElement('option'); o.value=r[0]; list.appendChild(o); } });
    };

    function autoId() {
        const nom = document.getElementById('sitio_nombre').value.toUpperCase();
        const f = dbS.find(l => l[4] && l[4].toUpperCase().includes(nom));
        if(f) document.getElementById('sitio_id').value = f[3];
    }

    function setEstado(est, btn) {
        document.querySelectorAll('.btn-opt').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('equipo_estado').value = est;
        document.getElementById('box_ref').style.display = (est==='DA√ëADO'||est==='NO UTILIZADO') ? 'block' : 'none';
        if(est==='DA√ëADO'||est==='NO UTILIZADO') cargarRef();
    }

    function cargarRef() {
        const id = document.getElementById('sitio_id').value;
        const sel = document.getElementById('ref_salida_desc');
        sel.innerHTML = '<option value="">Seleccione...</option>';
        dbS.forEach(f => { if(f[3]===id && f[9]==='PENDIENTE') { let o=document.createElement('option'); o.value=f[5]; o.textContent=f[5]; sel.appendChild(o); } });
    }

    function llenarDesdeSalida() {
        const ref = document.getElementById('ref_salida_desc').value;
        const f = dbS.find(l => l[5]===ref && l[9]==='PENDIENTE');
        if(f) { document.getElementById('equipo_desc').value=f[5]; document.getElementById('equipo_marca').value=f[6]; }
    }

    function autoMarca() {
        const d = document.getElementById('equipo_desc').value;
        const r = dbR.find(l => l[0]===d);
        if(r) document.getElementById('equipo_marca').value = r[1];
    }

    function setBodega(b, btn) {
        document.getElementById('bodega_destino').value = b;
        btn.classList.add('active');
    }

    async function enviar() {
        const urlParams = new URLSearchParams({
            action: "entregar",
            tecnico_nombre: document.getElementById('tecnico_nombre').value,
            sitio_id: document.getElementById('sitio_id').value,
            equipo_estado: document.getElementById('equipo_estado').value,
            ref_salida_desc: document.getElementById('ref_salida_desc').value,
            equipo_desc: document.getElementById('equipo_desc').value,
            equipo_marca: document.getElementById('equipo_marca').value,
            bodega_destino: document.getElementById('bodega_destino').value,
            equipo_serie: document.getElementById('equipo_serie').value,
            comentarios: document.getElementById('comentarios').value
        });

        const resp = await fetch("https://script.google.com/macros/s/AKfycbxFWYZb6qsKFTik0_oFxUFFwD3PLxTriU8eIN7-mHO3BlzO8CQQ6pFYZEAhCcfL68bh/exec", { method: 'POST', body: urlParams });
        const resText = await resp.text();
        alert(resText === "OK_ACTUALIZADO" || resText === "OK_NUEVO_REGISTRO" ? "‚úÖ Registro exitoso" : "‚ùå Error: " + resText);
        if(!resText.includes("ERROR")) location.reload();
    }
</script>
</body>
</html>

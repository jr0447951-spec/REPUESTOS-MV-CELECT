<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retorno de Equipos - CELECT-MV</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
        .group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; background-color: #1a73e8; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:hover { background-color: #1557b0; }
        #status { margin-top: 15px; text-align: center; font-size: 14px; padding: 10px; border-radius: 5px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>üîÑ Retorno de Equipo</h2>
    
    <div class="group">
        <label>ID del Sitio</label>
        <input type="text" id="idSitio" placeholder="Ej: SAL001" oninput="consultarPendientes()">
    </div>

    <div class="group">
        <label>Equipo a Entregar</label>
        <select id="equipoSelect">
            <option value="">-- Ingrese ID primero --</option>
        </select>
    </div>

    <div class="group">
        <label>Estado de Retorno</label>
        <select id="estado">
            <option value="USADO">USADO / FUNCIONAL</option>
            <option value="DA√ëADO">DA√ëADO / AVERIADO</option>
            <option value="NO UTILIZADO">NO UTILIZADO</option>
        </select>
    </div>

    <div class="group">
        <label>Confirmar Serie</label>
        <input type="text" id="serieConfirmada" placeholder="Ingrese n√∫mero de serie">
    </div>

    <button class="btn" onclick="ejecutarEntrega()">REGISTRAR ENTREGA</button>
    <div id="status"></div>
</div>

<script>
    const URL_CSV_SALIDAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?output=csv";
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycby5wT1f4xxRQvBrCaMuIQzwzsXxl5tqxFREl376TNjRIYhXFjrOSU2GobJby1KJ6rYg/exec";
    const URL_FORM = "https://docs.google.com/forms/d/e/1FAIpQLSfz-IGCT2vdfUplh2MipdjgBLcspDE_TWChhrWn1wBaVMnWOQ/formResponse";

    // 1. FILTRAR EQUIPOS PENDIENTES DESDE EL CSV
    async function consultarPendientes() {
        const idBuscado = document.getElementById('idSitio').value.trim().toUpperCase();
        if (idBuscado.length < 3) return;

        try {
            const response = await fetch(URL_CSV_SALIDAS);
            const data = await response.text();
            const filas = data.split("\n").map(f => f.split(","));
            
            const select = document.getElementById('equipoSelect');
            select.innerHTML = '<option value="">Seleccione equipo...</option>';

            filas.forEach(col => {
                // Columna D (3) = ID Sitio, Columna J (9) = Estado
                const idSheet = col[3]?.replace(/"/g, "").trim();
                const estadoSheet = col[9]?.replace(/"/g, "").trim();

                if (idSheet === idBuscado && estadoSheet === "PENDIENTE") {
                    let opt = document.createElement('option');
                    opt.value = col[5]; // Descripci√≥n (Columna F)
                    opt.textContent = col[5]; 
                    select.appendChild(opt);
                }
            });
        } catch (e) { console.error("Error CSV:", e); }
    }

    // 2. ENVIAR DATOS A FORMULARIO Y ACTUALIZAR EXCEL
    async function ejecutarEntrega() {
        const id = document.getElementById('idSitio').value;
        const equipo = document.getElementById('equipoSelect').value;
        const estado = document.getElementById('estado').value;
        const serie = document.getElementById('serieConfirmada').value;
        const statusDiv = document.getElementById('status');

        if (!equipo || !serie) {
            alert("Complete todos los campos");
            return;
        }

        statusDiv.style.display = "block";
        statusDiv.style.backgroundColor = "#fff3cd";
        statusDiv.innerHTML = "Procesando... no cierre la p√°gina.";

        try {
            // A. Env√≠o al Google Form (Back-up)
            const formParams = new URLSearchParams();
            formParams.append("entry.821288735", id);
            formParams.append("entry.1467261011", equipo);
            formParams.append("entry.1183702054", serie);
            fetch(`${URL_FORM}?${formParams.toString()}`, { mode: 'no-cors' });

            // B. Env√≠o al Script para marcar la fila en el Excel
            const scriptParams = new URLSearchParams();
            scriptParams.append("action", "entregar");
            scriptParams.append("descripcion", equipo);
            scriptParams.append("estado", estado);
            scriptParams.append("serie", serie);

            await fetch(`${URL_SCRIPT}?${scriptParams.toString()}`, { method: 'POST' });

            statusDiv.style.backgroundColor = "#d4edda";
            statusDiv.innerHTML = "‚úÖ Entrega registrada y stock actualizado.";
            setTimeout(() => location.reload(), 3000);

        } catch (e) {
            statusDiv.style.backgroundColor = "#f8d7da";
            statusDiv.innerHTML = "‚ùå Error en el proceso. Reintente.";
        }
    }
</script>

</body>
</html>
  }
</script>
</body>
</html>

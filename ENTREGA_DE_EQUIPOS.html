<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retorno de Equipos</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .box { background: white; padding: 20px; border-radius: 8px; max-width: 400px; margin: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input, select, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #27ae60; color: white; font-weight: bold; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <div class="box">
        <h2>üîÑ Retorno de Equipo</h2>
        <input type="text" id="idSitio" placeholder="ID del Sitio (Ej: SAL001)" oninput="cargarEquipos()">
        <select id="equipoSelect"><option value="">-- Seleccione Equipo --</option></select>
        <select id="estado"><option value="USADO">USADO / FUNCIONAL</option><option value="DA√ëADO">DA√ëADO</option></select>
        <input type="text" id="serie" placeholder="Confirmar Serie">
        <button onclick="registrar()">REGISTRAR ENTREGA</button>
        <p id="msg"></p>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzn16lKWQbMW-wdMufejz764fK-Kizf8WLNYcwHCCeL1aeEqMtsKbhNORQx6tFBBW0O/exec";
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBNrpLKc_GPFT6Ik9Yr4s1qo8zaOOqrDgTc_9DGeMd20rNTsEtLktTCoeDcRrts6kvgne86KZDfKQS/pub?output=csv";

        async function cargarEquipos() {
            const id = document.getElementById('idSitio').value.toUpperCase();
            if(id.length < 3) return;
            const res = await fetch(CSV_URL);
            const text = await res.text();
            const filas = text.split("\n").map(r => r.split(","));
            const select = document.getElementById('equipoSelect');
            select.innerHTML = '<option value="">-- Seleccione Equipo --</option>';
            
            filas.forEach(f => {
                if(f[3]?.replace(/"/g,"") == id && f[9]?.replace(/"/g,"") == "PENDIENTE") {
                    let opt = document.createElement('option');
                    opt.value = f[5].replace(/"/g,"");
                    opt.textContent = f[5].replace(/"/g,"");
                    select.appendChild(opt);
                }
            });
        }

        async function registrar() {
            const btn = document.querySelector("button");
            const msg = document.getElementById("msg");
            btn.disabled = true; msg.innerText = "Procesando...";

            const params = new URLSearchParams({
                action: "entregar",
                descripcion: document.getElementById('equipoSelect').value,
                estado: document.getElementById('estado').value,
                serie: document.getElementById('serie').value
            });

            try {
                const res = await fetch(SCRIPT_URL + "?" + params.toString(), { method: 'POST' });
                const text = await res.text();
                if(text.includes("EXITOSA")) {
                    msg.innerText = "‚úÖ Entrega anotada con fecha en el sistema.";
                    setTimeout(() => location.reload(), 2000);
                } else { msg.innerText = "‚ùå " + text; btn.disabled = false; }
            } catch(e) { msg.innerText = "‚ùå Error de conexi√≥n"; btn.disabled = false; }
        }
    </script>
</body>
</html>

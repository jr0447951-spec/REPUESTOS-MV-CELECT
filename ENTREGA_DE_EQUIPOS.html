<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entrega de Equipos</title>
  <style>
    :root { --success: #27ae60; --primary: #2c3e50; --danger: #e74c3c; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; background: #f4f4f4; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: var(--primary); margin-top: 0; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; font-size: 14px; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    input[readonly] { background-color: #eee; color: #555; }
    .hidden { display: none; }
    .btn-enviar { width: 100%; padding: 18px; background: var(--success); border: none; border-radius: 10px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    #status-msg { text-align: center; font-weight: bold; margin-top: 15px; color: var(--primary); }
    .ref-label { color: var(--danger); font-size: 13px; margin-top: 5px; display: block; }
  </style>
</head>
<body>

<div class="container">
    <h2>ENTREGA DE EQUIPOS</h2>
    
    <form id="form-entrega">
      <div class="form-group">
        <label>Técnico Responsable</label>
        <input type="text" id="ent_tecnico" required placeholder="Nombre completo">
      </div>

      <div class="form-group">
        <label>Nombre del Sitio (C)</label>
        <input type="text" id="ent_sitio" placeholder="Buscar sitio..." onblur="buscarPendientes()">
      </div>
      <div class="form-group">
        <label>ID Sitio (D)</label>
        <input type="text" id="ent_id_sitio" readonly>
      </div>

      <div class="form-group">
        <label>Estado del Equipo (E)</label>
        <select id="ent_estado" onchange="toggleLogicaEstado()" required>
          <option value="">Seleccione Estado...</option>
          <option value="DAÑADO">DAÑADO</option>
          <option value="NO UTILIZADO">NO UTILIZADO</option>
          <option value="USADO EN BUEN ESTADO">USADO EN BUEN ESTADO</option>
          <option value="POR REPARACION">POR REPARACIÓN</option>
        </select>
      </div>

      <div id="div_referencia" class="form-group hidden">
        <label class="ref-label">EQUIPO PENDIENTE DE RETORNO (F)</label>
        <select id="ent_ref_salida" onchange="copiarDatosSalida()">
          <option value="">Cargando equipos del sitio...</option>
        </select>
      </div>

      <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

      <div class="form-group">
        <label>Descripción / Modelo del Equipo (G)</label>
        <input type="text" id="ent_descripcion" required placeholder="Nombre del repuesto">
      </div>

      <div class="form-group">
        <label>Marca (H)</label>
        <input type="text" id="ent_marca" required>
      </div>

      <div class="form-group">
        <label>Bodega de Destino (I)</label>
        <select id="ent_bodega">
          <option value="SAN BENITO">SAN BENITO</option>
          <option value="CENTRAL">CENTRAL</option>
          <option value="TALNIQUE">TALNIQUE</option>
        </select>
      </div>

      <div class="form-group">
        <label>Número de Serie (J)</label>
        <input type="text" id="ent_serie" required placeholder="S/N">
      </div>

      <div class="form-group">
        <label>Comentarios o Problema (K)</label>
        <textarea id="ent_comentario" rows="3" placeholder="Detalles adicionales..."></textarea>
      </div>

      <button type="button" class="btn-enviar" onclick="enviarEntrega()">REGISTRAR ENTREGA</button>
    </form>
    <div id="status-msg"></div>
</div>

<script>
  // MAPEADO DE TUS ENTRY.ID
  const ENTRIES = {
    idSitio: "entry.821288735",
    nombreSitio: "entry.1024047478",
    marca: "entry.808319871",
    modelo: "entry.735015225",     
    serie: "entry.1183702054",
    estado: "entry.1370238515",
    problema: "entry.110589533",    
    tipoIngreso: "entry.1467261011", 
    bodega: "entry.1372699954",
    contrata: "entry.908256573"
  };

  function toggleLogicaEstado() {
    const estado = document.getElementById('ent_estado').value;
    const divRef = document.getElementById('div_referencia');
    if (estado === "DAÑADO" || estado === "NO UTILIZADO") {
      divRef.classList.remove('hidden');
    } else {
      divRef.classList.add('hidden');
      document.getElementById('ent_ref_salida').value = "";
    }
  }

  function buscarPendientes() {
    const idSitio = document.getElementById('ent_id_sitio').value;
    if (!idSitio) return;
    google.script.run.withSuccessHandler(function(json) {
      const pendientes = JSON.parse(json);
      const select = document.getElementById('ent_ref_salida');
      select.innerHTML = '<option value="">-- Seleccione el equipo --</option>';
      pendientes.forEach(p => {
        let opt = document.createElement('option');
        opt.value = p.descripcion;
        opt.text = p.descripcion + " (" + p.marca + ")";
        select.appendChild(opt);
      });
    }).obtenerEquiposPendientes(idSitio);
  }

  function copiarDatosSalida() {
    const equipo = document.getElementById('ent_ref_salida').value;
    if (equipo) document.getElementById('ent_descripcion').value = equipo;
  }

  function enviarEntrega() {
    // URL DE TU FORMULARIO PROPORCIONADO
    const baseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSfz-IGCT2vdfUplh2MipdjgBLcspDE_TWChhrWn1wBaVMnWOQ/formResponse?";
    
    const query = new URLSearchParams();
    query.append(ENTRIES.nombreSitio, document.getElementById('ent_sitio').value);
    query.append(ENTRIES.idSitio, document.getElementById('ent_id_sitio').value);
    query.append(ENTRIES.estado, document.getElementById('ent_estado').value);
    query.append(ENTRIES.tipoIngreso, document.getElementById('ent_ref_salida').value);
    query.append(ENTRIES.modelo, document.getElementById('ent_descripcion').value);
    query.append(ENTRIES.marca, document.getElementById('ent_marca').value);
    query.append(ENTRIES.bodega, document.getElementById('ent_bodega').value);
    query.append(ENTRIES.serie, document.getElementById('ent_serie').value);
    query.append(ENTRIES.problema, document.getElementById('ent_comentario').value);
    query.append(ENTRIES.contrata, "CELECT");

    document.getElementById('status-msg').innerText = "Enviando registro...";

    fetch(baseUrl + query.toString() + "&submit=Submit", { mode: 'no-cors' })
      .then(() => {
        document.getElementById('status-msg').innerText = "✅ Entrega registrada exitosamente";
        
        // Ejecución de marca en hoja de Salidas
        const ref = document.getElementById('ent_ref_salida').value;
        if(ref) google.script.run.marcarComoEntregado(ref);
        
        setTimeout(() => { location.reload(); }, 2500);
      })
      .catch(err => {
        document.getElementById('status-msg').innerText = "❌ Error al enviar";
      });
  }
</script>
</body>
</html>
